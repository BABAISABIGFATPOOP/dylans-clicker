<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pollution Clicker</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #0a0a0a 0%, #1a1a2e 50%, #2d1f3d 100%);
            min-height: 100vh;
            color: #fff;
            overflow-x: hidden;
        }

        .game-container {
            display: flex;
            min-height: 100vh;
        }

        .main-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .news-ticker {
            width: 100%;
            background: rgba(0, 0, 0, 0.8);
            border-bottom: 2px solid #333;
            padding: 12px 20px;
            position: fixed;
            top: 0;
            left: 0;
            z-index: 100;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .news-label {
            background: #ff4444;
            color: #fff;
            padding: 4px 10px;
            border-radius: 4px;
            font-weight: bold;
            font-size: 0.8rem;
            white-space: nowrap;
        }

        .news-text {
            color: #ccc;
            font-size: 0.95rem;
            flex: 1;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .news-text span {
            color: #ffd700;
        }

        .toxic-waste-display {
            position: fixed;
            top: 50px;
            right: 20px;
            background: rgba(0, 0, 0, 0.8);
            border: 2px solid #39ff14;
            border-radius: 10px;
            padding: 10px 15px;
            z-index: 99;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .toxic-waste-display:hover {
            border-color: #7fff00;
            transform: scale(1.05);
        }

        .toxic-waste-display .icon {
            font-size: 2rem;
            display: block;
            animation: glow-pulse 2s infinite;
        }

        .toxic-waste-display.ready .icon {
            animation: glow-pulse 0.5s infinite, bounce 0.5s infinite;
        }

        @keyframes glow-pulse {
            0%, 100% { filter: drop-shadow(0 0 5px #39ff14); }
            50% { filter: drop-shadow(0 0 15px #39ff14); }
        }

        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-5px); }
        }

        .toxic-waste-display .count {
            color: #39ff14;
            font-weight: bold;
            font-size: 1.1rem;
        }

        .toxic-waste-display .timer {
            color: #888;
            font-size: 0.75rem;
            margin-top: 3px;
        }

        .toxic-waste-shop {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #39ff14;
        }

        .toxic-upgrade {
            background: linear-gradient(135deg, #1a2a1a 0%, #0a1a0a 100%);
            border: 2px solid #2a4a2a;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .toxic-upgrade:hover:not(.disabled) {
            border-color: #39ff14;
        }

        .toxic-upgrade.disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .toxic-upgrade .name {
            color: #39ff14;
            font-weight: bold;
        }

        .toxic-upgrade .desc {
            color: #888;
            font-size: 0.8rem;
            margin: 5px 0;
        }

        .toxic-upgrade .cost {
            color: #7fff00;
            font-size: 0.9rem;
        }

        .sound-toggle {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.7);
            border: 2px solid #444;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            cursor: pointer;
            font-size: 1.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            z-index: 100;
        }

        .sound-toggle:hover {
            border-color: #888;
        }

        .prestige-display {
            position: fixed;
            top: 50px;
            left: 20px;
            background: rgba(0, 0, 0, 0.8);
            border: 2px solid #ffd700;
            border-radius: 10px;
            padding: 10px 15px;
            z-index: 99;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            max-width: 180px;
        }

        .prestige-display:hover {
            border-color: #ffec8b;
            transform: scale(1.05);
        }

        .prestige-display .icon {
            font-size: 1.8rem;
            display: block;
            animation: prestige-glow 3s infinite;
        }

        @keyframes prestige-glow {
            0%, 100% { filter: drop-shadow(0 0 5px #ffd700); }
            50% { filter: drop-shadow(0 0 15px #ffd700); }
        }

        .prestige-display .count {
            color: #ffd700;
            font-weight: bold;
            font-size: 1rem;
        }

        .prestige-display .potential {
            color: #aaa;
            font-size: 0.75rem;
            margin-top: 3px;
        }

        .prestige-display .potential span {
            color: #7fff00;
        }

        .prestige-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.9);
            z-index: 200;
            justify-content: center;
            align-items: center;
        }

        .prestige-modal.show {
            display: flex;
        }

        .prestige-content {
            background: linear-gradient(135deg, #1a1a2e 0%, #2d1f3d 100%);
            border: 3px solid #ffd700;
            border-radius: 20px;
            padding: 30px;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
            text-align: center;
        }

        .prestige-title {
            font-size: 2rem;
            color: #ffd700;
            margin-bottom: 20px;
            text-shadow: 0 0 20px rgba(255, 215, 0, 0.5);
        }

        .prestige-info {
            color: #ccc;
            margin-bottom: 20px;
            line-height: 1.6;
        }

        .prestige-gain {
            font-size: 1.5rem;
            color: #7fff00;
            margin: 20px 0;
            padding: 15px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
        }

        .prestige-multiplier {
            color: #ffd700;
            font-size: 1.2rem;
            margin: 10px 0;
        }

        .prestige-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 20px;
        }

        .prestige-btn {
            padding: 12px 30px;
            border: 2px solid;
            border-radius: 10px;
            font-size: 1.1rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .prestige-btn.confirm {
            background: linear-gradient(135deg, #2a5a2a 0%, #1a3a1a 100%);
            border-color: #7fff00;
            color: #7fff00;
        }

        .prestige-btn.confirm:hover {
            background: linear-gradient(135deg, #3a6a3a 0%, #2a4a2a 100%);
            transform: scale(1.05);
        }

        .prestige-btn.confirm:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .prestige-btn.cancel {
            background: linear-gradient(135deg, #5a2a2a 0%, #3a1a1a 100%);
            border-color: #ff6b6b;
            color: #ff6b6b;
        }

        .prestige-btn.cancel:hover {
            background: linear-gradient(135deg, #6a3a3a 0%, #4a2a2a 100%);
            transform: scale(1.05);
        }

        .prestige-upgrades-title {
            color: #ffd700;
            font-size: 1.3rem;
            margin: 25px 0 15px 0;
            border-top: 1px solid #ffd700;
            padding-top: 20px;
        }

        .prestige-upgrade {
            background: linear-gradient(135deg, #2a2a1a 0%, #1a1a0a 100%);
            border: 2px solid #4a4a2a;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.2s;
            text-align: left;
        }

        .prestige-upgrade:hover:not(.disabled):not(.maxed) {
            border-color: #ffd700;
        }

        .prestige-upgrade.disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .prestige-upgrade.maxed {
            border-color: #7fff00;
            opacity: 0.8;
        }

        .prestige-upgrade .name {
            color: #ffd700;
            font-weight: bold;
        }

        .prestige-upgrade .desc {
            color: #888;
            font-size: 0.8rem;
            margin: 5px 0;
        }

        .prestige-upgrade .cost {
            color: #ffec8b;
            font-size: 0.9rem;
        }

        .solar-system-bar {
            position: fixed;
            top: 50px;
            left: 0;
            right: 380px;
            background: rgba(0, 0, 0, 0.9);
            border-bottom: 2px solid #6a0dad;
            padding: 8px 15px;
            display: flex;
            align-items: center;
            gap: 10px;
            z-index: 98;
            overflow-x: auto;
        }

        .solar-system-label {
            color: #6a0dad;
            font-weight: bold;
            font-size: 0.8rem;
            white-space: nowrap;
        }

        .system-btn {
            padding: 5px 12px;
            border: 2px solid #444;
            border-radius: 15px;
            background: rgba(30, 0, 50, 0.6);
            color: #aaa;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.8rem;
            white-space: nowrap;
        }

        .system-btn:hover:not(.locked) {
            border-color: #6a0dad;
            color: #fff;
        }

        .system-btn.active {
            border-color: #9b30ff;
            background: rgba(155, 48, 255, 0.3);
            color: #fff;
        }

        .system-btn.locked {
            opacity: 0.4;
            cursor: not-allowed;
        }

        .system-multiplier {
            color: #9b30ff;
            font-size: 0.7rem;
        }

        .game-container {
            padding-top: 90px;
        }

        @media (max-width: 768px) {
            .solar-system-bar {
                right: 0;
                top: 50px;
            }
            .game-container {
                padding-top: 130px;
            }
        }

        .planet-selector {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .planet-tab {
            padding: 8px 16px;
            border: 2px solid #444;
            border-radius: 20px;
            background: rgba(0,0,0,0.4);
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.9rem;
        }

        .planet-tab:hover:not(.locked) {
            border-color: #888;
        }

        .planet-tab.active {
            border-color: #ffd700;
            background: rgba(255, 215, 0, 0.2);
        }

        .planet-tab.locked {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .planet-tab .planet-emoji {
            margin-right: 5px;
        }

        .score-display {
            text-align: center;
            margin-bottom: 30px;
        }

        .planet-name {
            font-size: 1.2rem;
            color: #888;
            margin-bottom: 5px;
        }

        .score {
            font-size: 2.5rem;
            font-weight: bold;
            color: #7cfc00;
            text-shadow: 0 0 20px rgba(124, 252, 0, 0.5);
        }

        .score.polluted {
            color: #ff4444;
            text-shadow: 0 0 20px rgba(255, 68, 68, 0.5);
        }

        .per-second {
            font-size: 1.2rem;
            color: #aaa;
            margin-top: 10px;
        }

        .multiplier {
            font-size: 1rem;
            color: #ffd700;
            margin-top: 5px;
        }

        .globe-container {
            position: relative;
            width: 280px;
            height: 280px;
        }

        .globe-btn {
            width: 250px;
            height: 250px;
            border-radius: 50%;
            border: none;
            cursor: pointer;
            position: relative;
            box-shadow:
                0 0 60px rgba(30, 87, 153, 0.4),
                inset -20px -20px 40px rgba(0, 0, 0, 0.4),
                inset 10px 10px 40px rgba(255, 255, 255, 0.1);
            transition: transform 0.1s, filter 0.3s, background 0.5s;
            overflow: hidden;
        }

        .globe-btn:hover {
            transform: scale(1.05);
        }

        .globe-btn:active {
            transform: scale(0.95);
        }

        .smog-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            background: radial-gradient(circle, rgba(139, 90, 43, 0) 0%, rgba(139, 90, 43, 0) 100%);
            pointer-events: none;
            transition: background 0.5s;
        }

        .pollution-particles {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }

        .shop-panel {
            width: 380px;
            background: rgba(0, 0, 0, 0.5);
            padding: 20px;
            border-left: 2px solid #333;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .shop-title {
            font-size: 1.5rem;
            text-align: center;
            margin-bottom: 10px;
            color: #ff6b6b;
            border-bottom: 2px solid #ff6b6b;
            padding-bottom: 10px;
            flex-shrink: 0;
        }

        .upgrades-scroll {
            flex: 1;
            overflow-y: auto;
            margin-bottom: 10px;
            padding-right: 5px;
            min-height: 200px;
        }

        .other-shops-scroll {
            flex: 1;
            overflow-y: auto;
            padding-right: 5px;
            border-top: 2px solid #444;
            padding-top: 10px;
        }

        .upgrades-scroll::-webkit-scrollbar,
        .other-shops-scroll::-webkit-scrollbar {
            width: 8px;
        }

        .upgrades-scroll::-webkit-scrollbar-track,
        .other-shops-scroll::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 4px;
        }

        .upgrades-scroll::-webkit-scrollbar-thumb {
            background: #ff6b6b;
            border-radius: 4px;
        }

        .other-shops-scroll::-webkit-scrollbar-thumb {
            background: #ffd700;
            border-radius: 4px;
        }

        .upgrades-scroll::-webkit-scrollbar-thumb:hover,
        .other-shops-scroll::-webkit-scrollbar-thumb:hover {
            background: #fff;
        }

        .section-title {
            font-size: 1.1rem;
            color: #ffd700;
            margin: 15px 0 10px 0;
            padding-bottom: 5px;
            border-bottom: 1px solid #ffd700;
        }

        .section-title:first-child {
            margin-top: 0;
        }

        .upgrade-item, .planet-item {
            background: linear-gradient(135deg, #2a2a3a 0%, #1a1a2a 100%);
            border: 2px solid #444;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .upgrade-item:hover:not(.disabled), .planet-item:hover:not(.disabled):not(.owned) {
            border-color: #ff6b6b;
        }

        .upgrade-item.disabled, .planet-item.disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .planet-item.owned {
            border-color: #4ade80;
            opacity: 0.7;
        }

        .upgrade-header, .planet-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .upgrade-name, .planet-unlock-name {
            font-size: 1.1rem;
            font-weight: bold;
        }

        .upgrade-icon, .planet-unlock-icon {
            font-size: 1.3rem;
            margin-right: 8px;
        }

        .upgrade-count {
            background: #ff6b6b;
            color: #000;
            padding: 2px 10px;
            border-radius: 15px;
            font-weight: bold;
        }

        .upgrade-desc, .planet-desc {
            font-size: 0.85rem;
            color: #aaa;
            margin-bottom: 8px;
        }

        .upgrade-cost, .planet-cost {
            color: #ff6b6b;
            font-weight: bold;
        }

        .planet-item.owned .planet-cost {
            color: #4ade80;
        }

        .upgrade-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 8px;
        }

        .upgrade-level {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .level-badge {
            background: linear-gradient(135deg, #39ff14 0%, #1a8a1a 100%);
            color: #000;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.75rem;
            font-weight: bold;
        }

        .level-btn {
            background: linear-gradient(135deg, #2a4a2a 0%, #1a2a1a 100%);
            border: 2px solid #39ff14;
            border-radius: 5px;
            color: #39ff14;
            padding: 3px 8px;
            font-size: 0.7rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .level-btn:hover:not(.disabled) {
            background: linear-gradient(135deg, #3a5a3a 0%, #2a3a2a 100%);
            transform: scale(1.05);
        }

        .level-btn.disabled {
            opacity: 0.4;
            cursor: not-allowed;
            border-color: #555;
            color: #555;
        }

        .level-bonus {
            color: #39ff14;
            font-size: 0.75rem;
        }

        .click-particle {
            position: fixed;
            pointer-events: none;
            font-size: 1.5rem;
            font-weight: bold;
            color: #888;
            text-shadow: 0 0 10px rgba(100, 100, 100, 0.8);
            animation: float-up 1s ease-out forwards;
            z-index: 1000;
        }

        @keyframes float-up {
            0% {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
            100% {
                opacity: 0;
                transform: translateY(-100px) scale(1.5);
            }
        }

        .smoke-particle {
            position: absolute;
            width: 8px;
            height: 8px;
            background: rgba(100, 100, 100, 0.6);
            border-radius: 50%;
            animation: smoke-rise 2s ease-out forwards;
        }

        @keyframes smoke-rise {
            0% {
                opacity: 0.8;
                transform: translateY(0) scale(1);
            }
            100% {
                opacity: 0;
                transform: translateY(-150px) scale(3);
            }
        }

        .stats {
            position: fixed;
            bottom: 20px;
            left: 20px;
            background: rgba(0, 0, 0, 0.7);
            padding: 15px 20px;
            border-radius: 10px;
            font-size: 0.9rem;
            border: 1px solid #333;
        }

        .stats div {
            margin: 5px 0;
        }

        .pollution-bar {
            width: 100%;
            height: 20px;
            background: #1a1a1a;
            border-radius: 10px;
            margin-top: 15px;
            overflow: hidden;
            border: 1px solid #333;
        }

        .pollution-fill {
            height: 100%;
            background: linear-gradient(90deg, #4ade80, #fbbf24, #f87171, #7c3aed);
            transition: width 0.3s;
            border-radius: 10px;
        }

        .pollution-label {
            text-align: center;
            margin-top: 8px;
            font-size: 0.9rem;
            color: #aaa;
        }

        @media (max-width: 768px) {
            .game-container {
                flex-direction: column;
            }
            .shop-panel {
                width: 100%;
                border-left: none;
                border-top: 2px solid #333;
                max-height: none;
                flex: none;
            }
            .upgrades-scroll {
                max-height: 300px;
                min-height: 150px;
            }
            .other-shops-scroll {
                max-height: 400px;
            }
            .globe-btn {
                width: 180px;
                height: 180px;
            }
            .globe-container {
                width: 200px;
                height: 200px;
            }
            .stats {
                position: static;
                margin: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="news-ticker">
        <div class="news-label">NEWS</div>
        <div class="news-text" id="news-text">Welcome to Earth. The air is still breathable... for now.</div>
    </div>
    <div class="toxic-waste-display" id="toxic-waste" title="Click to collect when ready!">
        <span class="icon">‚ò¢Ô∏è</span>
        <div class="count"><span id="toxic-count">0</span> Toxic Waste</div>
        <div class="timer" id="toxic-timer">Growing...</div>
    </div>
    <button class="sound-toggle" id="sound-toggle" title="Toggle Sound">üîä</button>
    <div class="prestige-display" id="prestige-display" title="Click to Rebirth!">
        <span class="icon">üíé</span>
        <div class="count"><span id="carbon-credits">0</span> Carbon Credits</div>
        <div class="potential">Rebirth for: <span id="prestige-potential">0</span></div>
    </div>
    <div class="prestige-modal" id="prestige-modal">
        <div class="prestige-content">
            <h2 class="prestige-title">üíé REBIRTH üíé</h2>
            <div class="prestige-info">
                Reset your pollution, upgrades, planets, and solar systems to start fresh with powerful permanent bonuses!
                <br><br>
                <strong>You keep:</strong> Carbon Credits, Toxic Waste, Prestige Upgrades
            </div>
            <div class="prestige-gain">
                You will earn: <span id="modal-prestige-gain">0</span> Carbon Credits
            </div>
            <div class="prestige-multiplier">
                Current Prestige Multiplier: x<span id="prestige-mult-display">1</span>
            </div>
            <div class="prestige-multiplier">
                After Rebirth: x<span id="prestige-mult-after">1</span>
            </div>
            <div class="prestige-upgrades-title">üíé Prestige Upgrades</div>
            <div id="prestige-upgrades-shop"></div>
            <div class="prestige-buttons">
                <button class="prestige-btn confirm" id="confirm-prestige">REBIRTH</button>
                <button class="prestige-btn cancel" id="cancel-prestige">Cancel</button>
            </div>
        </div>
    </div>
    <div class="solar-system-bar">
        <span class="solar-system-label">‚≠ê SOLAR SYSTEM:</span>
        <div id="system-buttons"></div>
    </div>
    <div class="game-container">
        <div class="main-area">
            <div class="planet-selector" id="planet-tabs"></div>
            <div class="score-display">
                <div class="planet-name" id="planet-name">Earth</div>
                <div class="score" id="score-text"><span id="pollution">0</span> tons of CO2</div>
                <div class="per-second">polluting at: <span id="pps">0</span>/sec</div>
                <div class="multiplier" id="multiplier-display">Multiplier: x1</div>
            </div>
            <div class="globe-container">
                <button class="globe-btn" id="globe" title="Pollute!"></button>
                <div class="smog-layer" id="smog"></div>
                <div class="pollution-particles" id="particles"></div>
            </div>
            <div class="pollution-bar">
                <div class="pollution-fill" id="pollution-fill" style="width: 0%"></div>
            </div>
            <div class="pollution-label"><span id="current-planet-name">Earth</span> Pollution: <span id="pollution-percent">0</span>%</div>
        </div>
        <div class="shop-panel">
            <h2 class="shop-title">Pollution Sources</h2>
            <div class="upgrades-scroll">
                <div id="upgrades"></div>
            </div>
            <div class="other-shops-scroll">
                <div class="section-title">Unlock Planets</div>
                <div id="planet-shop"></div>
                <div class="section-title" style="color: #39ff14; border-color: #39ff14;">‚ò¢Ô∏è Toxic Waste Upgrades</div>
                <div id="toxic-shop"></div>
                <div class="section-title" style="color: #9b30ff; border-color: #9b30ff;">‚≠ê Unlock Solar Systems</div>
                <div id="system-shop"></div>
            </div>
        </div>
    </div>
    <div class="stats">
        <div>Pollution Power: <span id="click-power">1</span> tons/click</div>
        <div>Total Clicks: <span id="total-clicks">0</span></div>
        <div>Total Pollution: <span id="total-pollution">0</span> tons</div>
        <div>Planets Destroyed: <span id="planets-destroyed">0</span></div>
        <div style="border-top: 1px solid #ffd700; margin-top: 8px; padding-top: 8px; color: #ffd700;">Rebirths: <span id="times-prestiged">0</span></div>
    </div>

    <script>
        // Planets
        const planets = [
            {
                id: 'earth',
                name: 'Earth',
                icon: 'üåç',
                unlocked: true,
                cost: 0,
                multiplier: 1,
                maxPollution: 1000000000000,
                pollution: 0,
                colors: {
                    clean: 'radial-gradient(circle at 30% 30%, #4a90d9, #1e5799 40%, #0d3a6e 70%, #082040)',
                    mid: 'radial-gradient(circle at 30% 30%, #5a9aca, #2a6a99 40%, #1a4a70 70%, #0a2a40)',
                    dirty: 'radial-gradient(circle at 30% 30%, #6a8b9a, #3d5c6e 40%, #2a4050 70%, #152030)',
                    dead: 'radial-gradient(circle at 30% 30%, #8b7355, #5c4a3a 40%, #3d3028 70%, #1a1510)'
                }
            },
            {
                id: 'mercury',
                name: 'Mercury',
                icon: 'ü™®',
                unlocked: false,
                cost: 5000000,
                multiplier: 1.5,
                maxPollution: 2000000000000,
                pollution: 0,
                colors: {
                    clean: 'radial-gradient(circle at 30% 30%, #9a9a9a, #7a7a7a 40%, #5a5a5a 70%, #3a3a3a)',
                    mid: 'radial-gradient(circle at 30% 30%, #8a8a8a, #6a6a6a 40%, #4a4a4a 70%, #2a2a2a)',
                    dirty: 'radial-gradient(circle at 30% 30%, #7a7a7a, #5a5a5a 40%, #3a3a3a 70%, #1a1a1a)',
                    dead: 'radial-gradient(circle at 30% 30%, #4a4a4a, #3a3a3a 40%, #2a2a2a 70%, #1a1a1a)'
                }
            },
            {
                id: 'venus',
                name: 'Venus',
                icon: 'üü°',
                unlocked: false,
                cost: 15000000,
                multiplier: 3,
                maxPollution: 8000000000000,
                pollution: 0,
                colors: {
                    clean: 'radial-gradient(circle at 30% 30%, #e6b800, #cc9900 40%, #997300 70%, #4d3a00)',
                    mid: 'radial-gradient(circle at 30% 30%, #cca300, #b38600 40%, #806000 70%, #403000)',
                    dirty: 'radial-gradient(circle at 30% 30%, #b38f00, #997a00 40%, #665200 70%, #332900)',
                    dead: 'radial-gradient(circle at 30% 30%, #6b5a28, #5a4a20 40%, #4a3a18 70%, #2a2010)'
                }
            },
            {
                id: 'mars',
                name: 'Mars',
                icon: 'üî¥',
                unlocked: false,
                cost: 50000000,
                multiplier: 5,
                maxPollution: 15000000000000,
                pollution: 0,
                colors: {
                    clean: 'radial-gradient(circle at 30% 30%, #c1440e, #8b3103 40%, #5c2102 70%, #2d1001)',
                    mid: 'radial-gradient(circle at 30% 30%, #a33d0d, #7a2e0a 40%, #4d1d06 70%, #261003)',
                    dirty: 'radial-gradient(circle at 30% 30%, #85360c, #632808 40%, #3e1905 70%, #1f0c02)',
                    dead: 'radial-gradient(circle at 30% 30%, #4a3728, #3a2a1e 40%, #2a1e14 70%, #1a100a)'
                }
            },
            {
                id: 'ceres',
                name: 'Ceres',
                icon: 'üåë',
                unlocked: false,
                cost: 200000000,
                multiplier: 8,
                maxPollution: 30000000000000,
                pollution: 0,
                colors: {
                    clean: 'radial-gradient(circle at 30% 30%, #8c8c8c, #6e6e6e 40%, #505050 70%, #323232)',
                    mid: 'radial-gradient(circle at 30% 30%, #7c7c7c, #5e5e5e 40%, #404040 70%, #222222)',
                    dirty: 'radial-gradient(circle at 30% 30%, #6c6c6c, #4e4e4e 40%, #303030 70%, #121212)',
                    dead: 'radial-gradient(circle at 30% 30%, #3c3c3c, #2e2e2e 40%, #202020 70%, #101010)'
                }
            },
            {
                id: 'jupiter',
                name: 'Jupiter',
                icon: 'üü†',
                unlocked: false,
                cost: 1000000000,
                multiplier: 15,
                maxPollution: 100000000000000,
                pollution: 0,
                colors: {
                    clean: 'radial-gradient(circle at 30% 30%, #d4a574, #c98b4a 40%, #a86e30 70%, #5c3d1a)',
                    mid: 'radial-gradient(circle at 30% 30%, #c49464, #b87a3a 40%, #985e20 70%, #4c2f10)',
                    dirty: 'radial-gradient(circle at 30% 30%, #b48354, #a86a2a 40%, #884e10 70%, #3c2100)',
                    dead: 'radial-gradient(circle at 30% 30%, #5a4a38, #4a3a28 40%, #3a2a18 70%, #2a1a08)'
                }
            },
            {
                id: 'saturn',
                name: 'Saturn',
                icon: 'ü™ê',
                unlocked: false,
                cost: 10000000000,
                multiplier: 25,
                maxPollution: 500000000000000,
                pollution: 0,
                colors: {
                    clean: 'radial-gradient(circle at 30% 30%, #e8d5a3, #d4bc7a 40%, #b89a50 70%, #6b5a30)',
                    mid: 'radial-gradient(circle at 30% 30%, #d8c593, #c4ac6a 40%, #a88a40 70%, #5b4a20)',
                    dirty: 'radial-gradient(circle at 30% 30%, #c8b583, #b49c5a 40%, #987a30 70%, #4b3a10)',
                    dead: 'radial-gradient(circle at 30% 30%, #6a5a40, #5a4a30 40%, #4a3a20 70%, #2a2010)'
                }
            },
            {
                id: 'neptune',
                name: 'Neptune',
                icon: 'üîµ',
                unlocked: false,
                cost: 100000000000,
                multiplier: 50,
                maxPollution: 2000000000000000,
                pollution: 0,
                colors: {
                    clean: 'radial-gradient(circle at 30% 30%, #4169e1, #3158c4 40%, #2147a7 70%, #112a6b)',
                    mid: 'radial-gradient(circle at 30% 30%, #3159d1, #2148b4 40%, #113797 70%, #011a5b)',
                    dirty: 'radial-gradient(circle at 30% 30%, #2149c1, #1138a4 40%, #012787 70%, #010a4b)',
                    dead: 'radial-gradient(circle at 30% 30%, #3a3a5a, #2a2a4a 40%, #1a1a3a 70%, #0a0a2a)'
                }
            },
            {
                id: 'pluto',
                name: 'Pluto',
                icon: '‚ö´',
                unlocked: false,
                cost: 500000000000,
                multiplier: 75,
                maxPollution: 5000000000000000,
                pollution: 0,
                colors: {
                    clean: 'radial-gradient(circle at 30% 30%, #a89f96, #8a827a 40%, #6c655e 70%, #3e3a36)',
                    mid: 'radial-gradient(circle at 30% 30%, #988f86, #7a726a 40%, #5c554e 70%, #2e2a26)',
                    dirty: 'radial-gradient(circle at 30% 30%, #887f76, #6a625a 40%, #4c453e 70%, #1e1a16)',
                    dead: 'radial-gradient(circle at 30% 30%, #4a4540, #3a3530 40%, #2a2520 70%, #1a1510)'
                }
            },
            {
                id: 'haumea',
                name: 'Haumea',
                icon: 'ü•ö',
                unlocked: false,
                cost: 2000000000000,
                multiplier: 100,
                maxPollution: 10000000000000000,
                pollution: 0,
                colors: {
                    clean: 'radial-gradient(circle at 30% 30%, #e8e8e8, #c8c8c8 40%, #a8a8a8 70%, #686868)',
                    mid: 'radial-gradient(circle at 30% 30%, #d8d8d8, #b8b8b8 40%, #989898 70%, #585858)',
                    dirty: 'radial-gradient(circle at 30% 30%, #c8c8c8, #a8a8a8 40%, #888888 70%, #484848)',
                    dead: 'radial-gradient(circle at 30% 30%, #686868, #585858 40%, #484848 70%, #282828)'
                }
            },
            {
                id: 'eris',
                name: 'Eris',
                icon: 'üå´Ô∏è',
                unlocked: false,
                cost: 10000000000000,
                multiplier: 150,
                maxPollution: 50000000000000000,
                pollution: 0,
                colors: {
                    clean: 'radial-gradient(circle at 30% 30%, #d4d4e0, #b4b4c8 40%, #9494b0 70%, #545478)',
                    mid: 'radial-gradient(circle at 30% 30%, #c4c4d0, #a4a4b8 40%, #8484a0 70%, #444468)',
                    dirty: 'radial-gradient(circle at 30% 30%, #b4b4c0, #9494a8 40%, #747490 70%, #343458)',
                    dead: 'radial-gradient(circle at 30% 30%, #5a5a70, #4a4a60 40%, #3a3a50 70%, #2a2a40)'
                }
            },
            {
                id: 'sun',
                name: 'The Sun',
                icon: '‚òÄÔ∏è',
                unlocked: false,
                cost: 100000000000000,
                multiplier: 500,
                maxPollution: 1000000000000000000,
                pollution: 0,
                colors: {
                    clean: 'radial-gradient(circle at 30% 30%, #ffdd00, #ffaa00 40%, #ff7700 70%, #cc4400)',
                    mid: 'radial-gradient(circle at 30% 30%, #ffcc00, #ff9900 40%, #ff6600 70%, #bb3300)',
                    dirty: 'radial-gradient(circle at 30% 30%, #ffbb00, #ff8800 40%, #ff5500 70%, #aa2200)',
                    dead: 'radial-gradient(circle at 30% 30%, #aa4400, #882200 40%, #661100 70%, #440800)'
                }
            }
        ];

        // Solar Systems
        const solarSystems = [
            {
                id: 'sol',
                name: 'Sol (Home)',
                icon: '‚òÄÔ∏è',
                unlocked: true,
                cost: 0,
                multiplier: 1,
                description: 'Our home solar system'
            },
            {
                id: 'alpha_centauri',
                name: 'Alpha Centauri',
                icon: '‚≠ê',
                unlocked: false,
                cost: 1e15,
                multiplier: 10,
                description: 'Nearest star system - 4.37 light years'
            },
            {
                id: 'trappist',
                name: 'TRAPPIST-1',
                icon: 'üî¥',
                unlocked: false,
                cost: 1e17,
                multiplier: 50,
                description: '7 Earth-sized planets to pollute!'
            },
            {
                id: 'kepler442',
                name: 'Kepler-442',
                icon: 'üü†',
                unlocked: false,
                cost: 1e19,
                multiplier: 200,
                description: 'Super-habitable world - 112 light years'
            },
            {
                id: 'gliese',
                name: 'Gliese 667C',
                icon: 'üî∂',
                unlocked: false,
                cost: 1e21,
                multiplier: 500,
                description: 'Triple star system - triple pollution!'
            },
            {
                id: 'kepler22',
                name: 'Kepler-22',
                icon: 'üåä',
                unlocked: false,
                cost: 1e23,
                multiplier: 1000,
                description: 'Ocean world - pollute the seas!'
            },
            {
                id: 'proxima',
                name: 'Proxima Centauri',
                icon: '‚ù§Ô∏è',
                unlocked: false,
                cost: 1e25,
                multiplier: 2500,
                description: 'Red dwarf with confirmed exoplanet'
            },
            {
                id: 'tau_ceti',
                name: 'Tau Ceti',
                icon: 'üíõ',
                unlocked: false,
                cost: 1e27,
                multiplier: 5000,
                description: 'Sun-like star - feels like home'
            },
            {
                id: 'andromeda',
                name: 'Andromeda Gateway',
                icon: 'üåÄ',
                unlocked: false,
                cost: 1e30,
                multiplier: 25000,
                description: 'Portal to another galaxy!'
            },
            {
                id: 'void',
                name: 'The Void Beyond',
                icon: 'üï≥Ô∏è',
                unlocked: false,
                cost: 1e35,
                multiplier: 100000,
                description: 'The space between realities'
            },
            {
                id: 'origin',
                name: 'The Origin Point',
                icon: 'üí•',
                unlocked: false,
                cost: 1e40,
                multiplier: 1000000,
                description: 'Where the Big Bang happened'
            }
        ];

        let currentSystemIndex = 0;

        let currentPlanetIndex = 0;
        let planetsDestroyed = 0;

        // Game State
        let pollution = 0;
        let pollutionPerClick = 1;
        let pollutionPerSecond = 0;
        let totalClicks = 0;
        let totalPollution = 0;

        // Toxic Waste System (like Sugar Lumps)
        let toxicWaste = 0;
        let toxicWasteProgress = 0;
        let toxicWasteReady = false;
        const toxicWasteTime = 300000; // 5 minutes to grow
        let lastToxicTime = Date.now();

        // Toxic Waste Upgrades
        const toxicUpgrades = [
            { id: 'toxic_click', name: 'Radioactive Fingers', desc: '+50% click power permanently', cost: 1, owned: 0, effect: 'clickMult', value: 0.5 },
            { id: 'toxic_auto', name: 'Mutant Workers', desc: '+50% auto pollution permanently', cost: 1, owned: 0, effect: 'autoMult', value: 0.5 },
            { id: 'toxic_speed', name: 'Accelerated Decay', desc: 'Toxic waste grows 20% faster', cost: 2, owned: 0, effect: 'wasteSpeed', value: 0.2 },
            { id: 'toxic_planet', name: 'Planetary Corruption', desc: '+25% to all planet multipliers', cost: 3, owned: 0, effect: 'planetMult', value: 0.25 },
            { id: 'toxic_double', name: 'Chain Reaction', desc: '10% chance for double toxic waste', cost: 5, owned: 0, effect: 'wasteDouble', value: 0.1 },
            { id: 'toxic_golden', name: 'Golden Sludge', desc: 'Rare golden waste worth 3x', cost: 5, owned: 0, effect: 'goldenChance', value: 0.1 },
            { id: 'toxic_mega', name: 'Mega Mutation', desc: '+100% to everything', cost: 10, owned: 0, effect: 'megaMult', value: 1.0 },
            { id: 'toxic_transcend', name: 'Transcend Reality', desc: 'Pollution transcends dimensions (+500%)', cost: 25, owned: 0, effect: 'transcend', value: 5.0 },
        ];

        // Toxic multipliers
        let toxicClickMult = 1;
        let toxicAutoMult = 1;
        let toxicWasteSpeedMult = 1;
        let toxicPlanetMult = 1;
        let toxicDoubleChance = 0;
        let toxicGoldenChance = 0;

        // Prestige System (Rebirth)
        let carbonCredits = 0;
        let lifetimePollution = 0; // Tracks pollution across all rebirths
        let timesPrestiged = 0;
        let prestigeMultiplier = 1;

        // Prestige Upgrades (permanent across rebirths)
        const prestigeUpgrades = [
            { id: 'p_click', name: 'Carbon Fingers', desc: 'x2 click power per level', cost: 1, owned: 0, maxLevel: 10, effect: 'clickMult', value: 2 },
            { id: 'p_auto', name: 'Carbon Automation', desc: 'x2 auto pollution per level', cost: 1, owned: 0, maxLevel: 10, effect: 'autoMult', value: 2 },
            { id: 'p_start', name: 'Head Start', desc: 'Start with 1000x more pollution', cost: 2, owned: 0, maxLevel: 5, effect: 'startBonus', value: 1000 },
            { id: 'p_cheap', name: 'Bulk Discount', desc: 'Upgrades cost 10% less per level', cost: 3, owned: 0, maxLevel: 5, effect: 'costReduction', value: 0.1 },
            { id: 'p_planet', name: 'Planetary Dominion', desc: 'x1.5 planet multipliers per level', cost: 5, owned: 0, maxLevel: 5, effect: 'planetBoost', value: 1.5 },
            { id: 'p_toxic', name: 'Radioactive Legacy', desc: 'Start with +1 Toxic Waste per level', cost: 5, owned: 0, maxLevel: 10, effect: 'toxicStart', value: 1 },
            { id: 'p_time', name: 'Time Dilation', desc: 'Toxic waste grows 25% faster per level', cost: 8, owned: 0, maxLevel: 5, effect: 'toxicSpeed', value: 0.25 },
            { id: 'p_system', name: 'Interstellar', desc: 'x2 solar system multipliers per level', cost: 10, owned: 0, maxLevel: 5, effect: 'systemBoost', value: 2 },
            { id: 'p_mega', name: 'Carbon Singularity', desc: 'x10 to everything!', cost: 50, owned: 0, maxLevel: 1, effect: 'megaBoost', value: 10 },
            { id: 'p_eternal', name: 'Eternal Pollution', desc: 'x100 prestige multiplier!', cost: 100, owned: 0, maxLevel: 1, effect: 'prestigeBoost', value: 100 },
        ];

        // Prestige multiplier bonuses
        let prestigeClickMult = 1;
        let prestigeAutoMult = 1;
        let prestigeStartBonus = 0;
        let prestigeCostReduction = 0;
        let prestigePlanetBoost = 1;
        let prestigeToxicStart = 0;
        let prestigeToxicSpeed = 0;
        let prestigeSystemBoost = 1;

        // Permanent Upgrade Levels (persist through prestige, bought with toxic waste)
        // Each level gives +100% power to that upgrade
        let upgradeLevels = {}; // { upgradeId: level }
        const maxUpgradeLevel = 10;
        const upgradeLevelCost = (level) => Math.ceil(Math.pow(1.5, level)); // 1, 2, 3, 5, 8, 12, 18, 27, 41, 61

        function getUpgradeLevel(upgradeId) {
            return upgradeLevels[upgradeId] || 0;
        }

        function getUpgradeLevelMultiplier(upgradeId) {
            const level = getUpgradeLevel(upgradeId);
            return 1 + level; // Each level = +100% (so level 1 = 2x, level 2 = 3x, etc.)
        }

        function canLevelUpgrade(upgradeId) {
            const currentLevel = getUpgradeLevel(upgradeId);
            if (currentLevel >= maxUpgradeLevel) return false;
            const cost = upgradeLevelCost(currentLevel);
            return toxicWaste >= cost;
        }

        function levelUpUpgrade(upgradeId) {
            const currentLevel = getUpgradeLevel(upgradeId);
            if (currentLevel >= maxUpgradeLevel) return;
            const cost = upgradeLevelCost(currentLevel);
            if (toxicWaste < cost) return;

            toxicWaste -= cost;
            upgradeLevels[upgradeId] = currentLevel + 1;

            const upgrade = upgrades.find(u => u.id === upgradeId);
            playSound('unlock');
            newsText.innerHTML = `‚ò¢Ô∏è <span>${upgrade ? upgrade.name : 'Upgrade'}</span> leveled up to ${currentLevel + 1}! +${(currentLevel + 1) * 100}% power!`;

            renderUpgrades();
            updateToxicWaste();
            saveGame();
        }

        // Calculate total click/auto power with upgrade levels
        function calculateClickPower() {
            let basePower = 1; // Base click power
            for (const upgrade of upgrades) {
                if (upgrade.type === 'click' && upgrade.owned > 0) {
                    basePower += upgrade.owned * upgrade.power * getUpgradeLevelMultiplier(upgrade.id);
                }
            }
            return basePower;
        }

        function calculateAutoPower() {
            let basePower = 0;
            for (const upgrade of upgrades) {
                if (upgrade.type === 'auto' && upgrade.owned > 0) {
                    basePower += upgrade.owned * upgrade.power * getUpgradeLevelMultiplier(upgrade.id);
                }
            }
            return basePower;
        }

        // Sound System
        let soundEnabled = true;
        const AudioContext = window.AudioContext || window.webkitAudioContext;
        let audioCtx = null;

        function initAudio() {
            if (!audioCtx) {
                audioCtx = new AudioContext();
            }
        }

        // Planet sound profiles - each planet has unique sound characteristics
        const planetSounds = {
            earth: { baseFreq: 300, type: 'sine', color: 'warm' },
            mercury: { baseFreq: 500, type: 'square', color: 'metallic' },
            venus: { baseFreq: 250, type: 'sawtooth', color: 'harsh' },
            mars: { baseFreq: 200, type: 'triangle', color: 'dusty' },
            ceres: { baseFreq: 400, type: 'sine', color: 'hollow' },
            jupiter: { baseFreq: 120, type: 'sawtooth', color: 'deep' },
            saturn: { baseFreq: 180, type: 'triangle', color: 'ringed' },
            neptune: { baseFreq: 350, type: 'sine', color: 'watery' },
            pluto: { baseFreq: 600, type: 'square', color: 'cold' },
            haumea: { baseFreq: 450, type: 'triangle', color: 'egg' },
            eris: { baseFreq: 280, type: 'sawtooth', color: 'chaotic' },
            sun: { baseFreq: 80, type: 'sawtooth', color: 'blazing' }
        };

        // Solar system sound modifiers
        const systemSounds = {
            sol: { freqMult: 1, detune: 0, reverb: 0.1 },
            alpha_centauri: { freqMult: 1.2, detune: 50, reverb: 0.2 },
            trappist: { freqMult: 0.8, detune: -30, reverb: 0.3 },
            kepler442: { freqMult: 1.5, detune: 100, reverb: 0.25 },
            gliese: { freqMult: 0.7, detune: -50, reverb: 0.4 },
            kepler22: { freqMult: 1.1, detune: 25, reverb: 0.5 },
            proxima: { freqMult: 0.9, detune: -20, reverb: 0.35 },
            tau_ceti: { freqMult: 1.0, detune: 10, reverb: 0.15 },
            andromeda: { freqMult: 1.8, detune: 200, reverb: 0.6 },
            void: { freqMult: 0.5, detune: -100, reverb: 0.8 },
            origin: { freqMult: 2.0, detune: 300, reverb: 1.0 }
        };

        function playSound(type) {
            if (!soundEnabled || !audioCtx) return;

            const oscillator = audioCtx.createOscillator();
            const gainNode = audioCtx.createGain();

            oscillator.connect(gainNode);
            gainNode.connect(audioCtx.destination);

            // Get current planet and system sound profiles
            const planet = planets[currentPlanetIndex];
            const system = solarSystems[currentSystemIndex];
            const pSound = planetSounds[planet?.id] || planetSounds.earth;
            const sSound = systemSounds[system?.id] || systemSounds.sol;

            switch(type) {
                case 'click':
                    // Sound varies by planet and system
                    const clickFreq = pSound.baseFreq * sSound.freqMult + Math.random() * 50;
                    oscillator.frequency.value = clickFreq;
                    oscillator.type = pSound.type;
                    oscillator.detune.value = sSound.detune + Math.random() * 20;
                    gainNode.gain.setValueAtTime(0.1, audioCtx.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.1 + sSound.reverb * 0.1);
                    oscillator.start(audioCtx.currentTime);
                    oscillator.stop(audioCtx.currentTime + 0.1 + sSound.reverb * 0.1);
                    // Add harmonic for certain planets
                    if (pSound.color === 'deep' || pSound.color === 'blazing') {
                        const osc2 = audioCtx.createOscillator();
                        const gain2 = audioCtx.createGain();
                        osc2.connect(gain2);
                        gain2.connect(audioCtx.destination);
                        osc2.frequency.value = clickFreq * 0.5;
                        osc2.type = 'sine';
                        gain2.gain.setValueAtTime(0.05, audioCtx.currentTime);
                        gain2.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.15);
                        osc2.start(audioCtx.currentTime);
                        osc2.stop(audioCtx.currentTime + 0.15);
                    }
                    break;
                case 'buy':
                    const buyFreq = (pSound.baseFreq + 100) * sSound.freqMult;
                    oscillator.frequency.value = buyFreq;
                    oscillator.type = pSound.type === 'sine' ? 'square' : pSound.type;
                    oscillator.detune.value = sSound.detune;
                    gainNode.gain.setValueAtTime(0.08, audioCtx.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.15);
                    oscillator.start(audioCtx.currentTime);
                    oscillator.stop(audioCtx.currentTime + 0.15);
                    // Second tone for confirmation
                    setTimeout(() => {
                        if (audioCtx) {
                            const osc2 = audioCtx.createOscillator();
                            const gain2 = audioCtx.createGain();
                            osc2.connect(gain2);
                            gain2.connect(audioCtx.destination);
                            osc2.frequency.value = buyFreq * 1.25;
                            osc2.type = 'sine';
                            osc2.detune.value = sSound.detune;
                            gain2.gain.setValueAtTime(0.06, audioCtx.currentTime);
                            gain2.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.1);
                            osc2.start(audioCtx.currentTime);
                            osc2.stop(audioCtx.currentTime + 0.1);
                        }
                    }, 80);
                    break;
                case 'toxic':
                    oscillator.frequency.value = 150;
                    oscillator.type = 'sawtooth';
                    gainNode.gain.setValueAtTime(0.15, audioCtx.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.4);
                    oscillator.start(audioCtx.currentTime);
                    oscillator.stop(audioCtx.currentTime + 0.4);
                    break;
                case 'unlock':
                    oscillator.frequency.value = 523;
                    oscillator.type = 'sine';
                    gainNode.gain.setValueAtTime(0.1, audioCtx.currentTime);
                    setTimeout(() => {
                        if (audioCtx) {
                            const osc2 = audioCtx.createOscillator();
                            const gain2 = audioCtx.createGain();
                            osc2.connect(gain2);
                            gain2.connect(audioCtx.destination);
                            osc2.frequency.value = 659;
                            osc2.type = 'sine';
                            gain2.gain.setValueAtTime(0.1, audioCtx.currentTime);
                            gain2.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.2);
                            osc2.start(audioCtx.currentTime);
                            osc2.stop(audioCtx.currentTime + 0.2);
                        }
                    }, 100);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.15);
                    oscillator.start(audioCtx.currentTime);
                    oscillator.stop(audioCtx.currentTime + 0.15);
                    break;
                case 'ready':
                    oscillator.frequency.value = 880;
                    oscillator.type = 'sine';
                    gainNode.gain.setValueAtTime(0.08, audioCtx.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.3);
                    oscillator.start(audioCtx.currentTime);
                    oscillator.stop(audioCtx.currentTime + 0.3);
                    break;
                case 'planet':
                    // Planet-specific whoosh sound
                    const planetStartFreq = pSound.baseFreq * 0.5;
                    const planetEndFreq = pSound.baseFreq * 2;
                    oscillator.frequency.value = planetStartFreq;
                    oscillator.type = pSound.type;
                    oscillator.detune.value = sSound.detune;
                    gainNode.gain.setValueAtTime(0.1, audioCtx.currentTime);
                    oscillator.frequency.exponentialRampToValueAtTime(planetEndFreq, audioCtx.currentTime + 0.3);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.3);
                    oscillator.start(audioCtx.currentTime);
                    oscillator.stop(audioCtx.currentTime + 0.3);
                    // Add planet-specific harmonic
                    if (pSound.color === 'watery' || pSound.color === 'ringed') {
                        const osc2 = audioCtx.createOscillator();
                        const gain2 = audioCtx.createGain();
                        osc2.connect(gain2);
                        gain2.connect(audioCtx.destination);
                        osc2.frequency.value = planetEndFreq * 1.5;
                        osc2.type = 'sine';
                        gain2.gain.setValueAtTime(0.05, audioCtx.currentTime + 0.1);
                        gain2.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.4);
                        osc2.start(audioCtx.currentTime + 0.1);
                        osc2.stop(audioCtx.currentTime + 0.4);
                    }
                    break;
                case 'system':
                    // System-specific epic warp sound
                    const warpBase = 100 * sSound.freqMult;
                    const warpEnd = 1200 * sSound.freqMult;
                    oscillator.frequency.value = warpBase;
                    oscillator.type = sSound.freqMult > 1.5 ? 'square' : 'sawtooth';
                    oscillator.detune.value = sSound.detune;
                    gainNode.gain.setValueAtTime(0.12, audioCtx.currentTime);
                    oscillator.frequency.exponentialRampToValueAtTime(warpEnd, audioCtx.currentTime + 0.5 + sSound.reverb * 0.3);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.5 + sSound.reverb * 0.3);
                    oscillator.start(audioCtx.currentTime);
                    oscillator.stop(audioCtx.currentTime + 0.5 + sSound.reverb * 0.3);
                    // Add system-specific harmonics
                    const numHarmonics = Math.ceil(sSound.reverb * 3) + 1;
                    for (let i = 0; i < numHarmonics; i++) {
                        setTimeout(() => {
                            if (audioCtx) {
                                const osc2 = audioCtx.createOscillator();
                                const gain2 = audioCtx.createGain();
                                osc2.connect(gain2);
                                gain2.connect(audioCtx.destination);
                                osc2.frequency.value = (400 + i * 200) * sSound.freqMult;
                                osc2.type = 'sine';
                                osc2.detune.value = sSound.detune + i * 50;
                                gain2.gain.setValueAtTime(0.06, audioCtx.currentTime);
                                gain2.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.3);
                                osc2.start(audioCtx.currentTime);
                                osc2.stop(audioCtx.currentTime + 0.3);
                            }
                        }, 150 + i * 100);
                    }
                    break;
                case 'destroy':
                    // Explosion/destruction sound
                    oscillator.frequency.value = 100;
                    oscillator.type = 'sawtooth';
                    gainNode.gain.setValueAtTime(0.2, audioCtx.currentTime);
                    oscillator.frequency.exponentialRampToValueAtTime(30, audioCtx.currentTime + 0.5);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.5);
                    oscillator.start(audioCtx.currentTime);
                    oscillator.stop(audioCtx.currentTime + 0.5);
                    break;
                case 'golden':
                    // Sparkly golden sound
                    oscillator.frequency.value = 1200;
                    oscillator.type = 'sine';
                    gainNode.gain.setValueAtTime(0.1, audioCtx.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.1);
                    oscillator.start(audioCtx.currentTime);
                    oscillator.stop(audioCtx.currentTime + 0.1);
                    setTimeout(() => {
                        if (audioCtx) {
                            const osc2 = audioCtx.createOscillator();
                            const gain2 = audioCtx.createGain();
                            osc2.connect(gain2);
                            gain2.connect(audioCtx.destination);
                            osc2.frequency.value = 1500;
                            osc2.type = 'sine';
                            gain2.gain.setValueAtTime(0.1, audioCtx.currentTime);
                            gain2.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.15);
                            osc2.start(audioCtx.currentTime);
                            osc2.stop(audioCtx.currentTime + 0.15);
                        }
                    }, 80);
                    setTimeout(() => {
                        if (audioCtx) {
                            const osc3 = audioCtx.createOscillator();
                            const gain3 = audioCtx.createGain();
                            osc3.connect(gain3);
                            gain3.connect(audioCtx.destination);
                            osc3.frequency.value = 1800;
                            osc3.type = 'sine';
                            gain3.gain.setValueAtTime(0.08, audioCtx.currentTime);
                            gain3.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.2);
                            osc3.start(audioCtx.currentTime);
                            osc3.stop(audioCtx.currentTime + 0.2);
                        }
                    }, 160);
                    break;
                case 'double':
                    // Power-up double sound
                    oscillator.frequency.value = 400;
                    oscillator.type = 'square';
                    gainNode.gain.setValueAtTime(0.1, audioCtx.currentTime);
                    oscillator.frequency.exponentialRampToValueAtTime(800, audioCtx.currentTime + 0.15);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.2);
                    oscillator.start(audioCtx.currentTime);
                    oscillator.stop(audioCtx.currentTime + 0.2);
                    break;
                case 'milestone':
                    // Achievement fanfare
                    const notes = [523, 659, 784, 1047];
                    notes.forEach((freq, i) => {
                        setTimeout(() => {
                            if (audioCtx) {
                                const osc = audioCtx.createOscillator();
                                const gain = audioCtx.createGain();
                                osc.connect(gain);
                                gain.connect(audioCtx.destination);
                                osc.frequency.value = freq;
                                osc.type = 'sine';
                                gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
                                gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.2);
                                osc.start(audioCtx.currentTime);
                                osc.stop(audioCtx.currentTime + 0.2);
                            }
                        }, i * 100);
                    });
                    return; // Early return since we're not using the main oscillator
                case 'error':
                    // Buzz/error sound
                    oscillator.frequency.value = 150;
                    oscillator.type = 'square';
                    gainNode.gain.setValueAtTime(0.1, audioCtx.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.2);
                    oscillator.start(audioCtx.currentTime);
                    oscillator.stop(audioCtx.currentTime + 0.2);
                    break;
                case 'news':
                    // Subtle notification blip
                    oscillator.frequency.value = 600;
                    oscillator.type = 'sine';
                    gainNode.gain.setValueAtTime(0.05, audioCtx.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.1);
                    oscillator.start(audioCtx.currentTime);
                    oscillator.stop(audioCtx.currentTime + 0.1);
                    break;
                case 'prestige':
                    // Epic rebirth sound - ascending sweep with harmonics
                    oscillator.frequency.value = 200;
                    oscillator.type = 'sine';
                    gainNode.gain.setValueAtTime(0.15, audioCtx.currentTime);
                    oscillator.frequency.exponentialRampToValueAtTime(2000, audioCtx.currentTime + 1);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 1);
                    oscillator.start(audioCtx.currentTime);
                    oscillator.stop(audioCtx.currentTime + 1);
                    // Add harmonic layers
                    [400, 600, 800].forEach((freq, i) => {
                        setTimeout(() => {
                            if (audioCtx) {
                                const osc = audioCtx.createOscillator();
                                const gain = audioCtx.createGain();
                                osc.connect(gain);
                                gain.connect(audioCtx.destination);
                                osc.frequency.value = freq;
                                osc.type = 'sine';
                                gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
                                osc.frequency.exponentialRampToValueAtTime(freq * 5, audioCtx.currentTime + 0.8);
                                gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.8);
                                osc.start(audioCtx.currentTime);
                                osc.stop(audioCtx.currentTime + 0.8);
                            }
                        }, i * 150);
                    });
                    return;
            }
        }

        // Upgrades
        const upgrades = [
            // CLICK UPGRADES
            { id: 'car', name: 'Old Car', icon: 'üöó', desc: '+1 ton per click', baseCost: 15, owned: 0, type: 'click', power: 1 },
            { id: 'suv', name: 'Gas Guzzler SUV', icon: 'üöô', desc: '+3 tons per click', baseCost: 50, owned: 0, type: 'click', power: 3 },
            { id: 'truck', name: 'Diesel Truck', icon: 'üöõ', desc: '+8 tons per click', baseCost: 150, owned: 0, type: 'click', power: 8 },
            { id: 'jet', name: 'Private Jet', icon: 'üõ©Ô∏è', desc: '+20 tons per click', baseCost: 500, owned: 0, type: 'click', power: 20 },
            { id: 'nuke', name: 'Nuclear Plant', icon: '‚ò¢Ô∏è', desc: '+50 tons per click', baseCost: 1500, owned: 0, type: 'click', power: 50 },
            { id: 'cruise', name: 'Cruise Ship', icon: 'üö¢', desc: '+120 tons per click', baseCost: 5000, owned: 0, type: 'click', power: 120 },
            { id: 'rocket', name: 'Rocket Launch', icon: 'üöÄ', desc: '+300 tons per click', baseCost: 15000, owned: 0, type: 'click', power: 300 },
            { id: 'chemical', name: 'Chemical Spill', icon: 'üß™', desc: '+700 tons per click', baseCost: 40000, owned: 0, type: 'click', power: 700 },
            { id: 'volcano', name: 'Volcano Drill', icon: 'üåã', desc: '+1,500 tons per click', baseCost: 100000, owned: 0, type: 'click', power: 1500 },
            { id: 'nuke_test', name: 'Nuclear Test', icon: 'üí•', desc: '+4,000 tons per click', baseCost: 300000, owned: 0, type: 'click', power: 4000 },
            { id: 'asteroid', name: 'Asteroid Mining', icon: '‚òÑÔ∏è', desc: '+10,000 tons per click', baseCost: 800000, owned: 0, type: 'click', power: 10000 },
            { id: 'antimatter', name: 'Antimatter Engine', icon: '‚öõÔ∏è', desc: '+25,000 tons per click', baseCost: 2500000, owned: 0, type: 'click', power: 25000 },
            { id: 'blackhole', name: 'Black Hole Generator', icon: 'üï≥Ô∏è', desc: '+75,000 tons per click', baseCost: 10000000, owned: 0, type: 'click', power: 75000 },
            { id: 'reality', name: 'Reality Corruptor', icon: 'üåÄ', desc: '+200,000 tons per click', baseCost: 50000000, owned: 0, type: 'click', power: 200000 },
            { id: 'dimension', name: 'Dimension Ripper', icon: 'üîÆ', desc: '+500,000 tons per click', baseCost: 200000000, owned: 0, type: 'click', power: 500000 },
            { id: 'timeline', name: 'Timeline Polluter', icon: '‚è∞', desc: '+1.5M tons per click', baseCost: 800000000, owned: 0, type: 'click', power: 1500000 },
            { id: 'multiverse', name: 'Multiverse Destroyer', icon: 'üåå', desc: '+5M tons per click', baseCost: 5000000000, owned: 0, type: 'click', power: 5000000 },
            { id: 'godhand', name: 'Hand of Pollution God', icon: '‚úã', desc: '+20M tons per click', baseCost: 50000000000, owned: 0, type: 'click', power: 20000000 },
            { id: 'cosmicfist', name: 'Cosmic Crusher', icon: 'üëä', desc: '+100M tons per click', baseCost: 500000000000, owned: 0, type: 'click', power: 100000000 },
            { id: 'eraser', name: 'Universe Eraser', icon: 'ü´≥', desc: '+500M tons per click', baseCost: 5000000000000, owned: 0, type: 'click', power: 500000000 },
            { id: 'finalclick', name: 'The Final Click', icon: 'üîò', desc: '+5B tons per click', baseCost: 100000000000000, owned: 0, type: 'click', power: 5000000000 },
            { id: 'infinitap', name: 'Infinite Tap', icon: '‚ôæÔ∏è', desc: '+50B tons per click', baseCost: 5000000000000000, owned: 0, type: 'click', power: 50000000000 },
            { id: 'creatorsfinger', name: "Creator's Finger", icon: '‚òùÔ∏è', desc: '+500B tons per click', baseCost: 500000000000000000, owned: 0, type: 'click', power: 500000000000 },
            // AUTO UPGRADES
            { id: 'factory', name: 'Coal Factory', icon: 'üè≠', desc: 'Emits 2 tons per second', baseCost: 50, owned: 0, type: 'auto', power: 2 },
            { id: 'cattle', name: 'Cattle Ranch', icon: 'üêÑ', desc: 'Produces 5 tons per second', baseCost: 150, owned: 0, type: 'auto', power: 5 },
            { id: 'plane', name: 'Airplane Fleet', icon: '‚úàÔ∏è', desc: 'Emits 15 tons per second', baseCost: 400, owned: 0, type: 'auto', power: 15 },
            { id: 'plastic', name: 'Plastic Factory', icon: 'üß¥', desc: 'Dumps 40 tons per second', baseCost: 1000, owned: 0, type: 'auto', power: 40 },
            { id: 'tanker', name: 'Oil Tanker', icon: 'üõ¢Ô∏è', desc: 'Spills 100 tons per second', baseCost: 3000, owned: 0, type: 'auto', power: 100 },
            { id: 'fracking', name: 'Fracking Operation', icon: '‚õèÔ∏è', desc: 'Leaks 250 tons per second', baseCost: 8000, owned: 0, type: 'auto', power: 250 },
            { id: 'powerplant', name: 'Coal Power Plant', icon: '‚ö°', desc: 'Burns 600 tons per second', baseCost: 20000, owned: 0, type: 'auto', power: 600 },
            { id: 'deforest', name: 'Deforestation Co. HQ', icon: 'ü™ì', desc: 'Destroys 1,500 tons per second', baseCost: 50000, owned: 0, type: 'auto', power: 1500 },
            { id: 'propaganda', name: 'Propaganda Network', icon: 'üì∫', desc: 'Enables 4,000 tons per second', baseCost: 150000, owned: 0, type: 'auto', power: 4000 },
            { id: 'oilrig', name: 'Offshore Oil Rig', icon: 'üõ¢Ô∏è', desc: 'Pumps 10,000 tons per second', baseCost: 400000, owned: 0, type: 'auto', power: 10000 },
            { id: 'megacorp', name: 'Mega Corporation', icon: 'üè¢', desc: 'Pollutes 25,000 tons per second', baseCost: 1000000, owned: 0, type: 'auto', power: 25000 },
            { id: 'lobby', name: 'Lobbying Firm', icon: 'üíº', desc: 'Blocks 60,000 tons per second', baseCost: 3000000, owned: 0, type: 'auto', power: 60000 },
            { id: 'government', name: 'Corrupt Government', icon: 'üèõÔ∏è', desc: 'Ignores 150,000 tons per second', baseCost: 8000000, owned: 0, type: 'auto', power: 150000 },
            { id: 'weather', name: 'Weather Machine', icon: 'üå™Ô∏è', desc: 'Weaponizes 400,000 tons per second', baseCost: 25000000, owned: 0, type: 'auto', power: 400000 },
            { id: 'mindcontrol', name: 'Mind Control Array', icon: 'üß†', desc: 'Converts 1M tons per second', baseCost: 80000000, owned: 0, type: 'auto', power: 1000000 },
            { id: 'dystopia', name: 'Dystopian Future', icon: 'üíÄ', desc: 'Destroys 3M tons per second', baseCost: 250000000, owned: 0, type: 'auto', power: 3000000 },
            { id: 'singularity', name: 'Pollution Singularity', icon: 'üåë', desc: 'Infinite: 10M tons per second', baseCost: 1000000000, owned: 0, type: 'auto', power: 10000000 },
            { id: 'starship', name: 'Pollution Starship', icon: 'üõ∏', desc: 'Spreads 50M tons per second', baseCost: 8000000000, owned: 0, type: 'auto', power: 50000000 },
            { id: 'dyson', name: 'Dyson Smog Sphere', icon: 'üîÜ', desc: 'Captures 200M tons per second', baseCost: 50000000000, owned: 0, type: 'auto', power: 200000000 },
            { id: 'galaxy', name: 'Galactic Polluter', icon: 'üåÄ', desc: 'Corrupts 1B tons per second', baseCost: 500000000000, owned: 0, type: 'auto', power: 1000000000 },
            { id: 'universal', name: 'Universal Blight', icon: 'üí´', desc: 'Infects 10B tons per second', baseCost: 5000000000000, owned: 0, type: 'auto', power: 10000000000 },
            { id: 'entropy', name: 'Entropy Accelerator', icon: '‚ôæÔ∏è', desc: 'Hastens 100B tons per second', baseCost: 100000000000000, owned: 0, type: 'auto', power: 100000000000 },
            { id: 'omega', name: 'The Omega Pollutant', icon: 'üÖæÔ∏è', desc: 'THE END: 1T tons per second', baseCost: 10000000000000000, owned: 0, type: 'auto', power: 1000000000000 },
            { id: 'voidspreader', name: 'Void Spreader', icon: 'üåë', desc: 'Consumes 10T tons per second', baseCost: 500000000000000000, owned: 0, type: 'auto', power: 10000000000000 },
            { id: 'realityeater', name: 'Reality Eater', icon: 'üëÅÔ∏è', desc: 'Devours 100T tons per second', baseCost: 50000000000000000000, owned: 0, type: 'auto', power: 100000000000000 },
            { id: 'eternalsmog', name: 'The Eternal Smog', icon: 'üå´Ô∏è', desc: 'FOREVER: 1Q tons per second', baseCost: 10000000000000000000000, owned: 0, type: 'auto', power: 1000000000000000 },
            { id: 'existencebane', name: 'Existence Bane', icon: 'üí¢', desc: 'Corrupts 10Q tons per second', baseCost: 1e24, owned: 0, type: 'auto', power: 1e16 },
            { id: 'theabsolute', name: 'The Absolute', icon: '‚¨õ', desc: 'INFINITE: 1Qi tons per second', baseCost: 1e27, owned: 0, type: 'auto', power: 1e18 }
        ];

        // DOM Elements
        const globeBtn = document.getElementById('globe');
        const smogLayer = document.getElementById('smog');
        const particlesContainer = document.getElementById('particles');
        const pollutionDisplay = document.getElementById('pollution');
        const ppsDisplay = document.getElementById('pps');
        const upgradesContainer = document.getElementById('upgrades');
        const planetShop = document.getElementById('planet-shop');
        const planetTabs = document.getElementById('planet-tabs');
        const clickPowerDisplay = document.getElementById('click-power');
        const totalClicksDisplay = document.getElementById('total-clicks');
        const totalPollutionDisplay = document.getElementById('total-pollution');
        const pollutionFill = document.getElementById('pollution-fill');
        const pollutionPercent = document.getElementById('pollution-percent');
        const scoreText = document.getElementById('score-text');
        const planetNameDisplay = document.getElementById('planet-name');
        const currentPlanetNameDisplay = document.getElementById('current-planet-name');
        const multiplierDisplay = document.getElementById('multiplier-display');
        const planetsDestroyedDisplay = document.getElementById('planets-destroyed');
        const newsText = document.getElementById('news-text');
        const toxicWasteDisplay = document.getElementById('toxic-waste');
        const toxicCountDisplay = document.getElementById('toxic-count');
        const toxicTimerDisplay = document.getElementById('toxic-timer');
        const toxicShop = document.getElementById('toxic-shop');
        const soundToggle = document.getElementById('sound-toggle');
        const systemButtons = document.getElementById('system-buttons');
        const systemShop = document.getElementById('system-shop');

        // Sound toggle
        soundToggle.addEventListener('click', () => {
            initAudio();
            soundEnabled = !soundEnabled;
            soundToggle.textContent = soundEnabled ? 'üîä' : 'üîá';
            if (soundEnabled) playSound('click');
        });

        // Prestige System functions
        const prestigeDisplay = document.getElementById('prestige-display');
        const carbonCreditsDisplay = document.getElementById('carbon-credits');
        const prestigePotentialDisplay = document.getElementById('prestige-potential');
        const prestigeModal = document.getElementById('prestige-modal');
        const modalPrestigeGain = document.getElementById('modal-prestige-gain');
        const prestigeMultDisplay = document.getElementById('prestige-mult-display');
        const prestigeMultAfter = document.getElementById('prestige-mult-after');
        const prestigeUpgradesShop = document.getElementById('prestige-upgrades-shop');
        const confirmPrestigeBtn = document.getElementById('confirm-prestige');
        const cancelPrestigeBtn = document.getElementById('cancel-prestige');

        function calculatePrestigeGain() {
            // Need at least 1 trillion total pollution to earn carbon credits
            if (totalPollution < 1e12) return 0;
            return Math.floor(Math.pow(totalPollution / 1e12, 0.5));
        }

        function calculatePrestigeMultiplier(credits) {
            // Each carbon credit gives +10% multiplier, compounding
            let mult = 1;
            for (const upgrade of prestigeUpgrades) {
                if (upgrade.id === 'p_eternal' && upgrade.owned > 0) {
                    mult *= upgrade.value;
                }
            }
            return mult * (1 + credits * 0.1);
        }

        function updatePrestigeDisplay() {
            carbonCreditsDisplay.textContent = formatNumber(carbonCredits);
            const potential = calculatePrestigeGain();
            prestigePotentialDisplay.textContent = potential > 0 ? '+' + formatNumber(potential) : '0';
            prestigeMultDisplay.textContent = formatNumber(prestigeMultiplier);

            const futureCredits = carbonCredits + potential;
            const futureMult = calculatePrestigeMultiplier(futureCredits);
            prestigeMultAfter.textContent = formatNumber(futureMult);
            modalPrestigeGain.textContent = formatNumber(potential);

            confirmPrestigeBtn.disabled = potential < 1;

            // Update rebirths display
            const timesPrestigedDisplay = document.getElementById('times-prestiged');
            if (timesPrestigedDisplay) {
                timesPrestigedDisplay.textContent = timesPrestiged;
            }
        }

        function applyPrestigeUpgrade(upgrade) {
            switch(upgrade.effect) {
                case 'clickMult':
                    prestigeClickMult *= upgrade.value;
                    break;
                case 'autoMult':
                    prestigeAutoMult *= upgrade.value;
                    break;
                case 'startBonus':
                    prestigeStartBonus += Math.log10(upgrade.value);
                    break;
                case 'costReduction':
                    prestigeCostReduction += upgrade.value;
                    break;
                case 'planetBoost':
                    prestigePlanetBoost *= upgrade.value;
                    break;
                case 'toxicStart':
                    prestigeToxicStart += upgrade.value;
                    break;
                case 'toxicSpeed':
                    prestigeToxicSpeed += upgrade.value;
                    break;
                case 'systemBoost':
                    prestigeSystemBoost *= upgrade.value;
                    break;
                case 'megaBoost':
                    prestigeClickMult *= upgrade.value;
                    prestigeAutoMult *= upgrade.value;
                    prestigePlanetBoost *= upgrade.value;
                    break;
                case 'prestigeBoost':
                    // Handled in calculatePrestigeMultiplier
                    break;
            }
        }

        function recalculatePrestigeBonuses() {
            prestigeClickMult = 1;
            prestigeAutoMult = 1;
            prestigeStartBonus = 0;
            prestigeCostReduction = 0;
            prestigePlanetBoost = 1;
            prestigeToxicStart = 0;
            prestigeToxicSpeed = 0;
            prestigeSystemBoost = 1;

            for (const upgrade of prestigeUpgrades) {
                for (let i = 0; i < upgrade.owned; i++) {
                    applyPrestigeUpgrade(upgrade);
                }
            }
        }

        function buyPrestigeUpgrade(upgrade) {
            if (carbonCredits >= upgrade.cost && upgrade.owned < upgrade.maxLevel) {
                carbonCredits -= upgrade.cost;
                upgrade.owned++;
                upgrade.cost = Math.ceil(upgrade.cost * 2);
                applyPrestigeUpgrade(upgrade);
                playSound('unlock');
                renderPrestigeShop();
                updatePrestigeDisplay();
                saveGame();
            }
        }

        function renderPrestigeShop() {
            prestigeUpgradesShop.innerHTML = '';
            prestigeUpgrades.forEach(upgrade => {
                const canAfford = carbonCredits >= upgrade.cost;
                const maxed = upgrade.owned >= upgrade.maxLevel;
                const div = document.createElement('div');
                div.className = 'prestige-upgrade' + (!canAfford && !maxed ? ' disabled' : '') + (maxed ? ' maxed' : '');
                div.innerHTML = `
                    <div class="name">üíé ${upgrade.name} ${upgrade.owned > 0 ? '(' + upgrade.owned + '/' + upgrade.maxLevel + ')' : ''}</div>
                    <div class="desc">${upgrade.desc}</div>
                    <div class="cost">${maxed ? 'MAXED' : 'Cost: ' + upgrade.cost + ' Carbon Credits'}</div>
                `;
                if (canAfford && !maxed) {
                    div.addEventListener('click', (e) => {
                        e.stopPropagation();
                        buyPrestigeUpgrade(upgrade);
                    });
                }
                prestigeUpgradesShop.appendChild(div);
            });
        }

        function doPrestige() {
            const gain = calculatePrestigeGain();
            if (gain < 1) return;

            // Award carbon credits
            carbonCredits += gain;
            lifetimePollution += totalPollution;
            timesPrestiged++;

            // Recalculate prestige multiplier
            prestigeMultiplier = calculatePrestigeMultiplier(carbonCredits);

            // Reset game state
            pollution = Math.pow(10, prestigeStartBonus); // Start bonus
            pollutionPerClick = 1;
            pollutionPerSecond = 0;
            totalClicks = 0;
            totalPollution = 0;
            currentPlanetIndex = 0;
            currentSystemIndex = 0;
            planetsDestroyed = 0;

            // Reset upgrades
            upgrades.forEach(u => {
                u.owned = 0;
            });

            // Reset planets
            planets.forEach((p, i) => {
                p.unlocked = i === 0;
                p.pollution = 0;
                p.destroyed = false;
                p.newsShown = false;
            });

            // Reset solar systems
            solarSystems.forEach((s, i) => {
                s.unlocked = i === 0;
            });

            // Reset toxic upgrades costs (but keep the upgrades themselves via toxic waste)
            // Actually keep toxic waste and toxic upgrades as stated

            // Apply toxic start bonus
            if (prestigeToxicStart > 0) {
                toxicWaste += prestigeToxicStart;
            }

            // Play sound and update
            playSound('prestige');
            newsText.innerHTML = `üíé <span>REBIRTH COMPLETE!</span> You transcend with ${formatNumber(gain)} Carbon Credits!`;

            // Close modal and refresh everything
            prestigeModal.classList.remove('show');

            const planet = getCurrentPlanet();
            planetNameDisplay.textContent = planet.name;
            currentPlanetNameDisplay.textContent = planet.name;
            multiplierDisplay.textContent = `Multiplier: x${planet.multiplier}`;
            planetsDestroyedDisplay.textContent = planetsDestroyed;

            renderPlanetTabs();
            renderUpgrades();
            renderPlanetShop();
            renderToxicShop();
            renderSystemButtons();
            renderSystemShop();
            updatePrestigeDisplay();
            updateDisplay();
            saveGame();
        }

        prestigeDisplay.addEventListener('click', () => {
            initAudio();
            updatePrestigeDisplay();
            renderPrestigeShop();
            prestigeModal.classList.add('show');
        });

        confirmPrestigeBtn.addEventListener('click', () => {
            doPrestige();
        });

        cancelPrestigeBtn.addEventListener('click', () => {
            prestigeModal.classList.remove('show');
        });

        // Close modal when clicking outside
        prestigeModal.addEventListener('click', (e) => {
            if (e.target === prestigeModal) {
                prestigeModal.classList.remove('show');
            }
        });

        // Solar System functions
        function getCurrentSystem() {
            return solarSystems[currentSystemIndex];
        }

        function renderSystemButtons() {
            systemButtons.innerHTML = '';
            solarSystems.forEach((system, index) => {
                const btn = document.createElement('button');
                btn.className = 'system-btn' + (index === currentSystemIndex ? ' active' : '') + (!system.unlocked ? ' locked' : '');
                btn.innerHTML = `${system.icon} ${system.name} <span class="system-multiplier">x${formatNumber(system.multiplier)}</span>`;
                if (system.unlocked) {
                    btn.addEventListener('click', () => switchSystem(index));
                }
                systemButtons.appendChild(btn);
            });
        }

        function switchSystem(index) {
            if (!solarSystems[index].unlocked) return;
            currentSystemIndex = index;
            playSound('system');
            newsText.innerHTML = `‚≠ê Traveling to <span>${solarSystems[index].name}</span>... ${solarSystems[index].description}`;
            const planet = getCurrentPlanet();
            const system = solarSystems[index];
            const totalMult = planet.multiplier * prestigePlanetBoost * system.multiplier * prestigeSystemBoost * prestigeMultiplier;
            multiplierDisplay.textContent = `Multiplier: x${formatNumber(totalMult)}`;
            renderSystemButtons();
            updateDisplay();
            saveGame();
        }

        function renderSystemShop() {
            systemShop.innerHTML = '';
            solarSystems.forEach((system, index) => {
                if (index === 0) return; // Skip Sol
                const canAfford = pollution >= system.cost;
                const div = document.createElement('div');
                div.className = 'toxic-upgrade' + (!canAfford && !system.unlocked ? ' disabled' : '') + (system.unlocked ? ' owned' : '');
                div.style.borderColor = system.unlocked ? '#9b30ff' : '';
                div.innerHTML = `
                    <div class="name" style="color: #9b30ff;">${system.icon} ${system.name}</div>
                    <div class="desc">${system.description}</div>
                    <div class="desc">x${formatNumber(system.multiplier)} system multiplier</div>
                    <div class="cost" style="color: #9b30ff;">${system.unlocked ? 'UNLOCKED' : 'Cost: ' + formatNumber(system.cost) + ' tons'}</div>
                `;
                if (!system.unlocked && canAfford) {
                    div.addEventListener('click', () => buySystem(index));
                }
                systemShop.appendChild(div);
            });
        }

        function buySystem(index) {
            const system = solarSystems[index];
            if (pollution >= system.cost && !system.unlocked) {
                pollution -= system.cost;
                system.unlocked = true;
                playSound('unlock');
                newsText.innerHTML = `‚≠ê <span>${system.name}</span> UNLOCKED! ${system.description}`;
                renderSystemButtons();
                renderSystemShop();
                updateDisplay();
                saveGame();
            }
        }

        // Toxic waste functions
        function updateToxicWaste() {
            const now = Date.now();
            const elapsed = now - lastToxicTime;
            const adjustedTime = toxicWasteTime / (toxicWasteSpeedMult + prestigeToxicSpeed);

            if (!toxicWasteReady) {
                toxicWasteProgress = Math.min(elapsed / adjustedTime, 1);

                if (toxicWasteProgress >= 1) {
                    toxicWasteReady = true;
                    toxicWasteDisplay.classList.add('ready');
                    toxicTimerDisplay.textContent = 'READY! Click to collect!';
                    playSound('ready');
                } else {
                    const remaining = Math.ceil((adjustedTime - elapsed) / 1000);
                    const mins = Math.floor(remaining / 60);
                    const secs = remaining % 60;
                    toxicTimerDisplay.textContent = `${mins}:${secs.toString().padStart(2, '0')} until ready`;
                }
            }

            toxicCountDisplay.textContent = toxicWaste;
        }

        function collectToxicWaste() {
            if (!toxicWasteReady) return;

            initAudio();
            let amount = 1;

            // Check for double chance
            if (Math.random() < toxicDoubleChance) {
                amount *= 2;
                newsText.innerHTML = "‚ò¢Ô∏è <span>CHAIN REACTION!</span> Double toxic waste collected!";
            }

            // Check for golden waste
            if (Math.random() < toxicGoldenChance) {
                amount *= 3;
                newsText.innerHTML = "‚ú® <span>GOLDEN SLUDGE!</span> Triple toxic waste collected!";
            }

            toxicWaste += amount;
            toxicWasteReady = false;
            toxicWasteProgress = 0;
            lastToxicTime = Date.now();
            toxicWasteDisplay.classList.remove('ready');
            playSound('toxic');
            updateToxicWaste();
            renderToxicShop();
            saveGame();
        }

        toxicWasteDisplay.addEventListener('click', collectToxicWaste);

        function applyToxicUpgrade(upgrade) {
            switch(upgrade.effect) {
                case 'clickMult':
                    toxicClickMult += upgrade.value;
                    break;
                case 'autoMult':
                    toxicAutoMult += upgrade.value;
                    break;
                case 'wasteSpeed':
                    toxicWasteSpeedMult += upgrade.value;
                    break;
                case 'planetMult':
                    toxicPlanetMult += upgrade.value;
                    break;
                case 'wasteDouble':
                    toxicDoubleChance += upgrade.value;
                    break;
                case 'goldenChance':
                    toxicGoldenChance += upgrade.value;
                    break;
                case 'megaMult':
                    toxicClickMult += upgrade.value;
                    toxicAutoMult += upgrade.value;
                    break;
                case 'transcend':
                    toxicClickMult += upgrade.value;
                    toxicAutoMult += upgrade.value;
                    toxicPlanetMult += upgrade.value * 0.5;
                    break;
            }
        }

        function buyToxicUpgrade(upgrade) {
            if (toxicWaste >= upgrade.cost) {
                toxicWaste -= upgrade.cost;
                upgrade.owned++;
                upgrade.cost = Math.ceil(upgrade.cost * 2.5); // Cost increases
                applyToxicUpgrade(upgrade);
                playSound('unlock');
                newsText.innerHTML = `‚ò¢Ô∏è <span>${upgrade.name}</span> activated! The mutation spreads...`;
                renderToxicShop();
                updateToxicWaste();
                saveGame();
            }
        }

        function renderToxicShop() {
            toxicShop.innerHTML = '';
            toxicUpgrades.forEach((upgrade, index) => {
                const canAfford = toxicWaste >= upgrade.cost;
                const div = document.createElement('div');
                div.className = 'toxic-upgrade' + (canAfford ? '' : ' disabled');
                div.innerHTML = `
                    <div class="name">‚ò¢Ô∏è ${upgrade.name} ${upgrade.owned > 0 ? '(x' + upgrade.owned + ')' : ''}</div>
                    <div class="desc">${upgrade.desc}</div>
                    <div class="cost">Cost: ${upgrade.cost} Toxic Waste</div>
                `;
                div.addEventListener('click', () => {
                    if (canAfford) buyToxicUpgrade(upgrade);
                });
                toxicShop.appendChild(div);
            });
        }

        // Update toxic waste timer
        setInterval(updateToxicWaste, 1000);

        function getCurrentPlanet() {
            return planets[currentPlanetIndex];
        }

        function getCost(upgrade) {
            const baseCost = Math.floor(upgrade.baseCost * Math.pow(1.15, upgrade.owned));
            const reduction = Math.min(prestigeCostReduction, 0.9); // Max 90% reduction
            return Math.floor(baseCost * (1 - reduction));
        }

        function formatNumber(num) {
            if (num >= 1e15) return (num / 1e15).toFixed(2) + 'Q';
            if (num >= 1e12) return (num / 1e12).toFixed(2) + 'T';
            if (num >= 1e9) return (num / 1e9).toFixed(2) + 'B';
            if (num >= 1e6) return (num / 1e6).toFixed(2) + 'M';
            if (num >= 1e3) return (num / 1e3).toFixed(2) + 'K';
            return Math.floor(num).toString();
        }

        function updatePlanetAppearance() {
            const planet = getCurrentPlanet();
            const percent = Math.min((planet.pollution / planet.maxPollution) * 100, 100);
            const smogOpacity = Math.min(percent / 100, 0.7);

            smogLayer.style.background = `radial-gradient(circle,
                rgba(139, 90, 43, ${smogOpacity * 0.5}) 0%,
                rgba(80, 60, 30, ${smogOpacity}) 50%,
                rgba(50, 40, 20, ${smogOpacity * 0.8}) 100%)`;

            if (percent > 75) {
                globeBtn.style.background = planet.colors.dead;
            } else if (percent > 50) {
                globeBtn.style.background = planet.colors.dirty;
            } else if (percent > 25) {
                globeBtn.style.background = planet.colors.mid;
            } else {
                globeBtn.style.background = planet.colors.clean;
            }

            pollutionFill.style.width = percent + '%';
            pollutionPercent.textContent = percent.toFixed(2);

            if (percent >= 100 && !planet.destroyed) {
                planet.destroyed = true;
                planetsDestroyed++;
                planetsDestroyedDisplay.textContent = planetsDestroyed;
            }

            if (percent > 50) {
                scoreText.classList.add('polluted');
            } else {
                scoreText.classList.remove('polluted');
            }
        }

        function renderPlanetTabs() {
            planetTabs.innerHTML = '';
            planets.forEach((planet, index) => {
                const tab = document.createElement('div');
                tab.className = 'planet-tab' + (index === currentPlanetIndex ? ' active' : '') + (!planet.unlocked ? ' locked' : '');
                tab.innerHTML = `<span class="planet-emoji">${planet.icon}</span>${planet.name}`;
                if (planet.unlocked) {
                    tab.addEventListener('click', () => switchPlanet(index));
                }
                planetTabs.appendChild(tab);
            });
        }

        function switchPlanet(index) {
            if (!planets[index].unlocked) return;
            currentPlanetIndex = index;
            playSound('planet');
            const planet = getCurrentPlanet();
            const system = getCurrentSystem();
            planetNameDisplay.textContent = planet.name;
            currentPlanetNameDisplay.textContent = planet.name;
            const totalMult = planet.multiplier * prestigePlanetBoost * system.multiplier * prestigeSystemBoost * prestigeMultiplier;
            multiplierDisplay.textContent = `Multiplier: x${formatNumber(totalMult)}`;
            renderPlanetTabs();
            updatePlanetAppearance();
            updateDisplay();
        }

        function renderPlanetShop() {
            planetShop.innerHTML = '';
            planets.forEach((planet, index) => {
                if (index === 0) return; // Skip Earth
                const canAfford = pollution >= planet.cost;
                const div = document.createElement('div');
                div.className = 'planet-item' + (!canAfford && !planet.unlocked ? ' disabled' : '') + (planet.unlocked ? ' owned' : '');
                div.setAttribute('data-planet-index', index);
                div.innerHTML = `
                    <div class="planet-header">
                        <span><span class="planet-unlock-icon">${planet.icon}</span><span class="planet-unlock-name">${planet.name}</span></span>
                    </div>
                    <div class="planet-desc">x${planet.multiplier} pollution multiplier</div>
                    <div class="planet-cost">${planet.unlocked ? 'UNLOCKED' : 'Cost: ' + formatNumber(planet.cost) + ' tons'}</div>
                `;
                planetShop.appendChild(div);
            });
        }

        planetShop.addEventListener('click', (e) => {
            const item = e.target.closest('.planet-item');
            if (item && !item.classList.contains('disabled') && !item.classList.contains('owned')) {
                const index = parseInt(item.getAttribute('data-planet-index'));
                if (!isNaN(index) && planets[index] && !planets[index].unlocked) {
                    buyPlanet(index);
                }
            }
        });

        function buyPlanet(index) {
            const planet = planets[index];
            if (pollution >= planet.cost && !planet.unlocked) {
                pollution -= planet.cost;
                planet.unlocked = true;
                renderPlanetTabs();
                renderPlanetShop();
                updateDisplay();
                saveGame();
            }
        }

        function createParticle(x, y, amount) {
            const particle = document.createElement('div');
            particle.className = 'click-particle';
            particle.textContent = '+' + formatNumber(amount);
            particle.style.left = x + 'px';
            particle.style.top = y + 'px';
            document.body.appendChild(particle);
            setTimeout(() => particle.remove(), 1000);
        }

        function createSmoke() {
            const smoke = document.createElement('div');
            smoke.className = 'smoke-particle';
            smoke.style.left = (Math.random() * 200 + 40) + 'px';
            smoke.style.top = (Math.random() * 100 + 100) + 'px';
            particlesContainer.appendChild(smoke);
            setTimeout(() => smoke.remove(), 2000);
        }

        function updateDisplay() {
            const planet = getCurrentPlanet();
            const system = getCurrentSystem();
            const totalMult = planet.multiplier * prestigePlanetBoost * system.multiplier * prestigeSystemBoost * prestigeMultiplier;
            const clickPower = calculateClickPower();
            const autoPower = calculateAutoPower();
            pollutionDisplay.textContent = formatNumber(pollution);
            ppsDisplay.textContent = formatNumber(autoPower * totalMult * toxicAutoMult * toxicPlanetMult * prestigeAutoMult);
            clickPowerDisplay.textContent = formatNumber(clickPower * totalMult * toxicClickMult * toxicPlanetMult * prestigeClickMult);
            totalClicksDisplay.textContent = formatNumber(totalClicks);
            totalPollutionDisplay.textContent = formatNumber(totalPollution);
            updatePlanetAppearance();
            updateUpgradeStates();
            updatePlanetShopStates();
        }

        function updateUpgradeStates() {
            const items = upgradesContainer.querySelectorAll('.upgrade-item');
            items.forEach((item, index) => {
                if (upgrades[index]) {
                    const cost = getCost(upgrades[index]);
                    const canAfford = pollution >= cost;
                    item.classList.toggle('disabled', !canAfford);
                }
            });
        }

        function updatePlanetShopStates() {
            const items = planetShop.querySelectorAll('.planet-item');
            items.forEach((item) => {
                const index = parseInt(item.getAttribute('data-planet-index'));
                if (!isNaN(index) && planets[index] && !planets[index].unlocked) {
                    const canAfford = pollution >= planets[index].cost;
                    item.classList.toggle('disabled', !canAfford);
                }
            });
        }

        function renderUpgrades() {
            upgradesContainer.innerHTML = '';
            upgrades.forEach((upgrade, index) => {
                const cost = getCost(upgrade);
                const canAfford = pollution >= cost;
                const level = getUpgradeLevel(upgrade.id);
                const levelCost = upgradeLevelCost(level);
                const canLevel = level < maxUpgradeLevel && toxicWaste >= levelCost;
                const levelMult = getUpgradeLevelMultiplier(upgrade.id);

                const div = document.createElement('div');
                div.className = 'upgrade-item' + (canAfford ? '' : ' disabled');
                div.setAttribute('data-index', index);
                div.innerHTML = `
                    <div class="upgrade-header">
                        <span><span class="upgrade-icon">${upgrade.icon}</span><span class="upgrade-name">${upgrade.name}</span></span>
                        <span class="upgrade-count">${upgrade.owned}</span>
                    </div>
                    <div class="upgrade-desc">${upgrade.desc}${levelMult > 1 ? ` <span style="color:#39ff14">(x${levelMult})</span>` : ''}</div>
                    <div class="upgrade-footer">
                        <span class="upgrade-cost">Cost: ${formatNumber(cost)} tons</span>
                        <div class="upgrade-level">
                            ${level > 0 ? `<span class="level-badge">Lv.${level}</span>` : ''}
                            <button class="level-btn ${canLevel ? '' : 'disabled'}" data-upgrade-id="${upgrade.id}" title="Spend ${levelCost} Toxic Waste to level up">
                                ${level >= maxUpgradeLevel ? 'MAX' : `‚ò¢Ô∏è +Lv (${levelCost})`}
                            </button>
                        </div>
                    </div>
                `;
                upgradesContainer.appendChild(div);
            });
        }

        upgradesContainer.addEventListener('click', (e) => {
            // Check if clicking level-up button
            const levelBtn = e.target.closest('.level-btn');
            if (levelBtn && !levelBtn.classList.contains('disabled')) {
                const upgradeId = levelBtn.getAttribute('data-upgrade-id');
                if (upgradeId) {
                    levelUpUpgrade(upgradeId);
                    return;
                }
            }

            // Otherwise, try to buy the upgrade
            const item = e.target.closest('.upgrade-item');
            if (item && !item.classList.contains('disabled')) {
                const index = parseInt(item.getAttribute('data-index'));
                if (!isNaN(index) && upgrades[index]) {
                    buyUpgrade(upgrades[index]);
                }
            }
        });

        function buyUpgrade(upgrade) {
            const cost = getCost(upgrade);
            if (pollution >= cost) {
                const wasFirstPurchase = upgrade.owned === 0;
                pollution -= cost;
                upgrade.owned++;
                if (upgrade.type === 'click') {
                    pollutionPerClick += upgrade.power;
                } else if (upgrade.type === 'auto') {
                    pollutionPerSecond += upgrade.power;
                }
                // Show news on first purchase
                if (wasFirstPurchase && storyMessages.upgrades[upgrade.id]) {
                    newsText.innerHTML = storyMessages.upgrades[upgrade.id];
                    playSound('unlock');
                } else {
                    playSound('buy');
                }
                renderUpgrades();
                updateDisplay();
                saveGame();
            }
        }

        globeBtn.addEventListener('click', (e) => {
            initAudio();
            const planet = getCurrentPlanet();
            const system = getCurrentSystem();
            const clickPower = calculateClickPower();
            const amount = clickPower * planet.multiplier * prestigePlanetBoost * system.multiplier * prestigeSystemBoost * toxicClickMult * toxicPlanetMult * prestigeClickMult * prestigeMultiplier;
            pollution += amount;
            planet.pollution += amount;
            totalClicks++;
            totalPollution += amount;

            const rect = globeBtn.getBoundingClientRect();
            const x = e.clientX || (rect.left + rect.width / 2);
            const y = e.clientY || (rect.top + rect.height / 2);
            createParticle(x - 20, y - 20, amount);

            for (let i = 0; i < 3; i++) {
                setTimeout(() => createSmoke(), i * 100);
            }

            playSound('click');
            updateDisplay();
        });

        setInterval(() => {
            const autoPower = calculateAutoPower();
            if (autoPower > 0) {
                const planet = getCurrentPlanet();
                const system = getCurrentSystem();
                const amount = (autoPower * planet.multiplier * prestigePlanetBoost * system.multiplier * prestigeSystemBoost * toxicAutoMult * toxicPlanetMult * prestigeAutoMult * prestigeMultiplier) / 10;
                pollution += amount;
                planet.pollution += amount;
                totalPollution += amount;
                updateDisplay();

                if (Math.random() < 0.3) {
                    createSmoke();
                }
            }
        }, 100);

        function saveGame() {
            const saveData = {
                pollution,
                pollutionPerClick,
                pollutionPerSecond,
                totalClicks,
                totalPollution,
                currentPlanetIndex,
                planetsDestroyed,
                upgrades: upgrades.map(u => ({ id: u.id, owned: u.owned })),
                planets: planets.map(p => ({ id: p.id, unlocked: p.unlocked, pollution: p.pollution, destroyed: p.destroyed })),
                // Toxic waste data
                toxicWaste,
                lastToxicTime,
                toxicUpgrades: toxicUpgrades.map(u => ({ id: u.id, owned: u.owned, cost: u.cost })),
                toxicClickMult,
                toxicAutoMult,
                toxicWasteSpeedMult,
                toxicPlanetMult,
                toxicDoubleChance,
                toxicGoldenChance,
                soundEnabled,
                // Solar system data
                currentSystemIndex,
                solarSystems: solarSystems.map(s => ({ id: s.id, unlocked: s.unlocked })),
                // Prestige data
                carbonCredits,
                lifetimePollution,
                timesPrestiged,
                prestigeMultiplier,
                prestigeUpgrades: prestigeUpgrades.map(u => ({ id: u.id, owned: u.owned, cost: u.cost })),
                prestigeClickMult,
                prestigeAutoMult,
                prestigeStartBonus,
                prestigeCostReduction,
                prestigePlanetBoost,
                prestigeToxicStart,
                prestigeToxicSpeed,
                prestigeSystemBoost,
                // Permanent upgrade levels (persist through prestige)
                upgradeLevels
            };
            localStorage.setItem('pollutionClickerSave', JSON.stringify(saveData));
        }

        function loadGame() {
            const saved = localStorage.getItem('pollutionClickerSave');
            if (saved) {
                const data = JSON.parse(saved);
                pollution = data.pollution || 0;
                pollutionPerClick = data.pollutionPerClick || 1;
                pollutionPerSecond = data.pollutionPerSecond || 0;
                totalClicks = data.totalClicks || 0;
                totalPollution = data.totalPollution || 0;
                currentPlanetIndex = data.currentPlanetIndex || 0;
                planetsDestroyed = data.planetsDestroyed || 0;

                if (data.upgrades) {
                    data.upgrades.forEach(savedUpgrade => {
                        const upgrade = upgrades.find(u => u.id === savedUpgrade.id);
                        if (upgrade) upgrade.owned = savedUpgrade.owned;
                    });
                }

                if (data.planets) {
                    data.planets.forEach(savedPlanet => {
                        const planet = planets.find(p => p.id === savedPlanet.id);
                        if (planet) {
                            planet.unlocked = savedPlanet.unlocked;
                            planet.pollution = savedPlanet.pollution || 0;
                            planet.destroyed = savedPlanet.destroyed || false;
                        }
                    });
                }

                // Load toxic waste data
                toxicWaste = data.toxicWaste || 0;
                lastToxicTime = data.lastToxicTime || Date.now();
                toxicClickMult = data.toxicClickMult || 1;
                toxicAutoMult = data.toxicAutoMult || 1;
                toxicWasteSpeedMult = data.toxicWasteSpeedMult || 1;
                toxicPlanetMult = data.toxicPlanetMult || 1;
                toxicDoubleChance = data.toxicDoubleChance || 0;
                toxicGoldenChance = data.toxicGoldenChance || 0;
                soundEnabled = data.soundEnabled !== undefined ? data.soundEnabled : true;

                if (data.toxicUpgrades) {
                    data.toxicUpgrades.forEach(savedUpgrade => {
                        const upgrade = toxicUpgrades.find(u => u.id === savedUpgrade.id);
                        if (upgrade) {
                            upgrade.owned = savedUpgrade.owned;
                            upgrade.cost = savedUpgrade.cost;
                        }
                    });
                }

                // Load solar system data
                currentSystemIndex = data.currentSystemIndex || 0;
                if (data.solarSystems) {
                    data.solarSystems.forEach(savedSystem => {
                        const system = solarSystems.find(s => s.id === savedSystem.id);
                        if (system) {
                            system.unlocked = savedSystem.unlocked;
                        }
                    });
                }

                // Load prestige data
                carbonCredits = data.carbonCredits || 0;
                lifetimePollution = data.lifetimePollution || 0;
                timesPrestiged = data.timesPrestiged || 0;
                prestigeMultiplier = data.prestigeMultiplier || 1;
                prestigeClickMult = data.prestigeClickMult || 1;
                prestigeAutoMult = data.prestigeAutoMult || 1;
                prestigeStartBonus = data.prestigeStartBonus || 0;
                prestigeCostReduction = data.prestigeCostReduction || 0;
                prestigePlanetBoost = data.prestigePlanetBoost || 1;
                prestigeToxicStart = data.prestigeToxicStart || 0;
                prestigeToxicSpeed = data.prestigeToxicSpeed || 0;
                prestigeSystemBoost = data.prestigeSystemBoost || 1;

                if (data.prestigeUpgrades) {
                    data.prestigeUpgrades.forEach(savedUpgrade => {
                        const upgrade = prestigeUpgrades.find(u => u.id === savedUpgrade.id);
                        if (upgrade) {
                            upgrade.owned = savedUpgrade.owned;
                            upgrade.cost = savedUpgrade.cost;
                        }
                    });
                }

                // Load permanent upgrade levels
                if (data.upgradeLevels) {
                    upgradeLevels = data.upgradeLevels;
                }

                soundToggle.textContent = soundEnabled ? 'üîä' : 'üîá';
            }
        }

        setInterval(saveGame, 30000);

        // Story System
        let lastStoryIndex = -1;
        let storyPhase = 0;

        const storyMessages = {
            // Early game - innocent beginnings
            early: [
                "Welcome to Earth. The air is still breathable... for now.",
                "Scientists warn about rising CO2 levels. Nobody listens.",
                "A small company called <span>Deforestation Co.</span> files for a business license.",
                "Local factory opens. Promises 'minimal environmental impact.'",
                "News: Person clicks globe for fun. Experts concerned.",
                "<span>Deforestation Co.</span> CEO: 'Trees are overrated anyway.'",
                "Climate protesters gather. <span>Deforestation Co.</span> offers them jobs.",
                "Study finds pollution 'not that bad.' Study funded by coal industry.",
            ],
            // Getting worse
            rising: [
                "<span>Deforestation Co.</span> acquires three competing lumber companies.",
                "Breaking: Amazon rainforest now 'Amazon parking lot.'",
                "<span>Deforestation Co.</span> lobbying firm wins 'Most Effective' award.",
                "Oil spill declared 'free seasoning for fish' by industry spokesman.",
                "Penguins seen wearing tiny gas masks. Scientists baffled.",
                "<span>Deforestation Co.</span> sponsors local little league. Team renamed 'The Smog.'",
                "New study: Trees 'had it coming.' Source: <span>Deforestation Co.</span>",
                "Coal factory wins 'Greenest Building' award. Judges were blindfolded.",
                "Birds flying south. And east. And west. Anywhere but here.",
            ],
            // Mid game - corporate takeover
            corporate: [
                "<span>Deforestation Co.</span> named 'Company of the Year' by Pollution Weekly.",
                "Breaking: <span>Deforestation Co.</span> purchases entire government. 'Good investment,' says CEO.",
                "New law: Breathing clean air now requires premium subscription.",
                "<span>Deforestation Co.</span> rebrands: 'We're not killing the planet, we're giving it character.'",
                "Last polar bear seen applying for refugee status.",
                "Oceans now 40% plastic. <span>Deforestation Co.</span>: 'Free building materials!'",
                "Sun appears red. <span>Deforestation Co.</span> claims credit for 'aesthetic improvement.'",
                "Scientists who criticized pollution missing. Unrelated, says <span>Deforestation Co.</span>",
                "New <span>Deforestation Co.</span> slogan: 'Earth was boring green anyway.'",
            ],
            // Late game - dystopia
            dystopia: [
                "<span>Deforestation Co.</span> announces plans to pollute other planets. 'Earth was just practice.'",
                "Breaking: Breathable air now sold in bottles. <span>Deforestation Co.</span> brand.",
                "Last tree on Earth purchased by <span>Deforestation Co.</span> CEO. Used as toothpick.",
                "Mars colony established. First building: <span>Deforestation Co.</span> factory.",
                "Children ask: 'What was grass?' Parents don't remember either.",
                "<span>Deforestation Co.</span> achieves monopoly on all life-sustaining resources.",
                "Earth's atmosphere now 'crunchy.' Scientists can't explain.",
                "The sun looks different today. <span>Deforestation Co.</span> targeting it next.",
                "<span>Deforestation Co.</span> IPO breaks all records. Stock price: your soul.",
            ],
            // End game - cosmic horror
            cosmic: [
                "<span>Deforestation Co.</span> successfully pollutes the sun. 'Our greatest achievement.'",
                "The void between stars fills with smog. <span>Deforestation Co.</span> expands infinitely.",
                "Aliens make contact. Immediately regret it. Leave quickly.",
                "Time itself now sponsored by <span>Deforestation Co.</span>",
                "The universe asks <span>Deforestation Co.</span> to stop. Request denied.",
                "Reality begins to smell like diesel. This is normal now.",
                "God calls. <span>Deforestation Co.</span> puts Him on hold.",
                "Heat death of universe accelerated. <span>Deforestation Co.</span> calls it 'efficiency.'",
                "There is only <span>Deforestation Co.</span> There was only ever <span>Deforestation Co.</span>",
            ],
            // Planet-specific
            planets: {
                mercury: "Mercury acquired. <span>Deforestation Co.</span>: 'Already hot, perfect for industry.'",
                venus: "Venus colonized. 'Finally, a planet that matches our vision,' says CEO.",
                mars: "Mars terraforming complete. It's now brown instead of red.",
                ceres: "Ceres strip-mined. <span>Deforestation Co.</span> finds it 'cute.'",
                jupiter: "Jupiter's Great Red Spot now Great Brown Spot. 'Improvement,' claims company.",
                saturn: "Saturn's rings replaced with smog rings. 'More mysterious,' says PR team.",
                neptune: "Neptune reached. Even here, <span>Deforestation Co.</span> finds something to ruin.",
                pluto: "Pluto polluted. 'Not even a real planet and we got it anyway.'",
                haumea: "Haumea conquered. Its weird shape now weirder.",
                eris: "Eris falls to <span>Deforestation Co.</span> Discord goddess approves.",
                sun: "THE SUN HAS BEEN POLLUTED. <span>DEFORESTATION CO.</span> WINS. EXISTENCE LOSES.",
            },
            // Random flavor
            random: [
                "Intern accidentally creates new greenhouse gas. Gets promoted.",
                "Fish evolve lungs. Immediately regret decision.",
                "Cloud seeding replaced with smog seeding. 'Same thing,' says expert.",
                "Volcano erupts. <span>Deforestation Co.</span> sues for copyright infringement.",
                "Rainbow now has 50 shades of gray.",
                "Wind turbines repurposed as giant fans to spread pollution faster.",
                "Electric cars banned. 'Too clean,' rules <span>Deforestation Co.</span> court.",
                "Ocean cleanup cancelled. 'The plastic stays,' announces CEO.",
                "Recycling outlawed. '<span>Deforestation Co.</span> needs job security.'",
                "Nature documentary becomes horror film. No CGI needed.",
            ],
            // Upgrade-specific stories (triggered on first purchase)
            upgrades: {
                car: "Your first polluting vehicle! <span>Deforestation Co.</span> sends a welcome basket.",
                suv: "SUV acquired. 8 miles per gallon. <span>Deforestation Co.</span> approves.",
                truck: "Diesel truck rolling coal down Main Street. Pedestrians coughing.",
                jet: "BREAKING: Local person buys private jet. Carbon footprint now visible from space.",
                nuke: "Nuclear plant online. 'Totally safe,' says guy in hazmat suit.",
                cruise: "Cruise ship launched! Each passenger produces 3x more CO2 than at home.",
                rocket: "Rocket program initiated. The sky is no longer the limit for pollution.",
                chemical: "ALERT: Chemical spill reported. <span>Deforestation Co.</span>: 'It's a feature.'",
                volcano: "Scientists baffled as someone drills into active volcano 'for fun.'",
                nuke_test: "FLASH: Nuclear test conducted. Birds now glow. 'Convenient,' says hunter.",
                asteroid: "Space mining begins! <span>Deforestation Co.</span> expands beyond Earth.",
                antimatter: "Antimatter engine created. Physics textbooks being rewritten with more pollution.",
                blackhole: "BLACK HOLE GENERATOR ONLINE. Scientists: 'This seems bad.' <span>Deforestation Co.</span>: 'Seems profitable.'",
                reality: "REALITY ITSELF NOW POLLUTED. <span>Deforestation Co.</span> transcends physical law.",
                dimension: "DIMENSION RIPPER ONLINE. Other dimensions now experience our pollution.",
                timeline: "TIMELINE POLLUTER ACTIVATED. The past and future are now equally polluted.",
                multiverse: "MULTIVERSE DESTROYER ENGAGED. Infinite realities, infinite pollution.",
                godhand: "THE HAND OF THE POLLUTION GOD MANIFESTS. <span>Deforestation Co.</span> achieves divinity.",
                cosmicfist: "THE COSMIC CRUSHER DESCENDS. Galaxies tremble at <span>Deforestation Co.</span>'s might.",
                eraser: "UNIVERSE ERASER ACTIVATED. Existence itself begs for mercy. Request denied.",
                finalclick: "THE FINAL CLICK. There is nothing left to click. You have clicked everything.",
                infinitap: "INFINITE TAP ACHIEVED. Each click echoes through infinite dimensions simultaneously.",
                creatorsfinger: "THE CREATOR'S FINGER TOUCHES DOWN. Even gods pollute now.",
                factory: "First factory built! The Industrial Revolution 2.0 begins.",
                cattle: "Cattle ranch established. Methane production: maximum. Cows: confused.",
                plane: "Airplane fleet takes off! Chemtrails now actual chemicals.",
                plastic: "Plastic factory opens. Ocean wildlife sends formal complaint. Complaint ignored.",
                tanker: "Oil tanker fleet deployed. Seagulls now permanently greased.",
                fracking: "FRACKING BEGINS. Tap water now flammable. <span>Deforestation Co.</span>: 'Free heating!'",
                powerplant: "Coal power plant operational. Local mountains now 'mountain-shaped holes.'",
                deforest: "<span>DEFORESTATION CO. HEADQUARTERS ESTABLISHED!</span> The real game begins now.",
                propaganda: "Propaganda network launched! 'Pollution is good for you' now trending.",
                oilrig: "Offshore oil rig constructed. Fish formally request relocation assistance.",
                megacorp: "<span>Deforestation Co.</span> achieves Mega Corporation status. Resistance is futile.",
                lobby: "Lobbying firm hired. Environmental laws now 'suggestions.'",
                government: "GOVERNMENT ACQUIRED. <span>Deforestation Co.</span> CEO now makes the laws.",
                weather: "Weather machine activated! Sunny days are now 'legacy features.'",
                mindcontrol: "MIND CONTROL ARRAY ONLINE. Everyone loves pollution now. Compliance is happiness.",
                dystopia: "DYSTOPIAN FUTURE ACHIEVED. <span>Deforestation Co.</span>'s vision is complete.",
                singularity: "POLLUTION SINGULARITY REACHED. All matter is now pollution. Pollution is all.",
                starship: "POLLUTION STARSHIP LAUNCHED. <span>Deforestation Co.</span> takes to the stars!",
                dyson: "DYSON SMOG SPHERE COMPLETE. The sun itself now powers our pollution.",
                galaxy: "GALACTIC POLLUTER ACTIVATED. The Milky Way will never be the same.",
                universal: "UNIVERSAL BLIGHT SPREADING. The cosmos darkens with <span>Deforestation Co.</span>'s touch.",
                entropy: "ENTROPY ACCELERATOR ENGAGED. Heat death comes faster now. 'Efficiency,' says CEO.",
                omega: "THE OMEGA POLLUTANT RELEASED. This is the end. This is perfection. This is <span>Deforestation Co.</span>",
                voidspreader: "THE VOID SPREADER AWAKENS. The space between atoms fills with smog.",
                realityeater: "REALITY EATER UNLEASHED. It consumes not just matter, but the concept of clean air.",
                eternalsmog: "THE ETERNAL SMOG. It was here before time. It will be here after. It is <span>Deforestation Co.</span>",
                existencebane: "EXISTENCE BANE DEPLOYED. The very concept of 'existing' now comes with emissions.",
                theabsolute: "THE ABSOLUTE. There is no more. There is no less. There is only pollution. <span>Deforestation Co.</span> is complete."
            }
        };

        function getStoryPhase() {
            if (totalPollution >= 1e17) return 'cosmic';
            if (totalPollution >= 1e14) return 'dystopia';
            if (totalPollution >= 1e11) return 'corporate';
            if (totalPollution >= 1e8) return 'rising';
            return 'early';
        }

        function getRandomNews() {
            const phase = getStoryPhase();
            const messages = storyMessages[phase];

            // 20% chance for random flavor text
            if (Math.random() < 0.2) {
                const randomMsgs = storyMessages.random;
                return randomMsgs[Math.floor(Math.random() * randomMsgs.length)];
            }

            // Check for planet-specific messages
            for (const planet of planets) {
                if (planet.unlocked && !planet.newsShown && planet.id !== 'earth') {
                    planet.newsShown = true;
                    if (storyMessages.planets[planet.id]) {
                        return storyMessages.planets[planet.id];
                    }
                }
            }

            let index;
            do {
                index = Math.floor(Math.random() * messages.length);
            } while (index === lastStoryIndex && messages.length > 1);

            lastStoryIndex = index;
            return messages[index];
        }

        function updateNews() {
            newsText.innerHTML = getRandomNews();
        }

        // Update news every 15 seconds
        setInterval(updateNews, 15000);

        // Initialize
        loadGame();
        const planet = getCurrentPlanet();
        const initSystem = getCurrentSystem();
        planetNameDisplay.textContent = planet.name;
        currentPlanetNameDisplay.textContent = planet.name;
        const initTotalMult = planet.multiplier * prestigePlanetBoost * initSystem.multiplier * prestigeSystemBoost * prestigeMultiplier;
        multiplierDisplay.textContent = `Multiplier: x${formatNumber(initTotalMult)}`;
        planetsDestroyedDisplay.textContent = planetsDestroyed;
        renderPlanetTabs();
        renderUpgrades();
        renderPlanetShop();
        renderToxicShop();
        renderSystemButtons();
        renderSystemShop();
        updateToxicWaste();
        updatePrestigeDisplay();
        updateDisplay();

        // Update prestige display every 2 seconds
        setInterval(updatePrestigeDisplay, 2000);
    </script>
</body>
</html>
